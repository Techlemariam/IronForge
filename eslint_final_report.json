[{"filePath":"C:\\Users\\alexa\\Workspaces\\IronForge\\src\\features\\dashboard\\DashboardClient.tsx","messages":[{"ruleId":null,"fatal":true,"severity":2,"message":"Parsing error: Declaration or statement expected.","line":10,"column":0,"nodeType":null}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport React, { useReducer, useEffect, useState } from \"react\";\r\nimport { toast } from \"@/components/ui/GameToast\";\r\nimport { PwaInstallBanner } from \"@/components/ui/PwaInstallBanner\";\r\nimport Link from \"next/link\";\r\nimport { useRouter } from \"next/navigation\";\r\n\r\nimport { Exercise } from \"@/types/ironforge\";\r\n} from \"@/types\";\r\n\r\nimport { saveWorkoutAction } from \"@/actions/integrations/hevy\";\r\n\r\nimport { AnimatePresence, motion } from \"framer-motion\";\r\nimport { mapQuestToHevyPayload } from \"@/utils/hevyAdapter\";\r\n\r\n\r\nimport { getProgressionAction } from \"@/actions/progression/core\";\r\nimport GeminiLiveCoach from \"@/features/training/components/GeminiLiveCoach\";\r\nimport { Settings } from \"lucide-react\";\r\n\r\n\r\nimport { Faction } from \"@/types/training\";\r\nimport { OracleChat } from \"@/features/oracle/components/OracleChat\";\r\n\r\n// Dynamic Imports moved to ViewRouter\r\nimport { FirstLoginQuest } from \"@/features/onboarding/FirstLoginQuest\";\r\nimport { PersistentHeader } from \"@/components/core/PersistentHeader\";\r\nimport { CoachToggle } from \"./components/CoachToggle\";\r\nimport { ViewRouter } from \"./components/ViewRouter\";\r\nimport { CodexLoader } from \"./components/SecondaryViews\";\r\nimport {\r\n  View,\r\n  DashboardState,\r\n  DashboardClientProps,\r\n} from \"./types\";\r\nimport { dashboardReducer } from \"./logic/dashboardReducer\";\r\nimport { useAmbientSound } from \"@/hooks/useAmbientSound\";\r\nimport { usePlatformContext } from \"@/hooks/usePlatformContext\";\r\nimport { TvHud } from \"@/components/ui/TvHud\";\r\n\r\nconst getAmbientZone = (\r\n  view: View,\r\n): \"citadel\" | \"forge\" | \"arena\" | \"wilds\" | \"void\" => {\r\n  switch (view) {\r\n    case \"citadel\":\r\n    case \"war_room\":\r\n    case \"training_center\":\r\n    case \"social_hub\":\r\n    case \"guild_hall\":\r\n    case \"program_builder\":\r\n    case \"trophy_room\":\r\n    case \"strength_log\":\r\n    case \"strava_upload\":\r\n    case \"cardio_studio\":\r\n      return \"citadel\";\r\n    case \"forge\":\r\n    case \"armory\":\r\n    case \"item_shop\":\r\n    case \"marketplace\":\r\n      return \"forge\";\r\n    case \"arena\":\r\n    case \"combat_arena\":\r\n    case \"world_map\":\r\n    case \"bestiary\":\r\n      return \"arena\";\r\n    case \"grimoire\":\r\n      return \"void\";\r\n    case \"import_routines\": // <-- Added\r\n      return \"citadel\";\r\n    default:\r\n      return \"citadel\";\r\n  }\r\n};\r\n\r\n// Consolidated Data Object from Server\r\n\r\nconst DashboardClient: React.FC<DashboardClientProps> = (props) => {\r\n  const {\r\n    initialData,\r\n    userData,\r\n    faction,\r\n    hasCompletedOnboarding,\r\n    pocketCastsConnected,\r\n    challenges,\r\n    titanState,\r\n    liteMode,\r\n  } = props;\r\n\r\n  // Leaderboard data passed from server component (or empty for backward-compat)\r\n  const leaderboardData = props.leaderboardData || [];\r\n\r\n  // Use Titan State if available, fallback to User (Legacy)\r\n  const level = titanState?.level || userData?.level || 1;\r\n  const nameMap = new Map<string, string>();\r\n  // Checking page.tsx again: it doesn't pass nameMap in initialData. It was passing it before.\r\n  // We should probably derive it or accept it.\r\n  // The previous code had `nameMap: Map<string, string>` in InitialDataProps.\r\n  // Let's assume for now we use an empty map or fetch it.\r\n\r\n  const initialStateFromProps: DashboardState = {\r\n    isCodexLoading: false,\r\n    wellnessData: initialData.wellness,\r\n    ttb: initialData.ttb,\r\n    level: level,\r\n    activeQuest: null,\r\n    questTitle: \"\",\r\n    exerciseNameMap: nameMap,\r\n    startTime: null,\r\n    currentView: \"citadel\",\r\n    oracleRecommendation: initialData.recommendation, // rename matched\r\n    auditReport: initialData.auditReport,\r\n    weaknessAudit: initialData.auditReport?.highestPriorityGap\r\n      ? {\r\n        detected: true,\r\n        type: \"NONE\",\r\n        message: `Focus: ${initialData.auditReport.highestPriorityGap.muscleGroup}`,\r\n        confidence: 1,\r\n      }\r\n      : null,\r\n    forecast: initialData.forecast,\r\n    events: initialData.events,\r\n    titanAnalysis: initialData.titanAnalysis,\r\n    isCoachOpen: false,\r\n    activeBossId: null,\r\n    activePath: initialData.activePath || \"WARDEN\",\r\n    mobilityLevel: userData?.mobilityLevel || \"NONE\",\r\n    recoveryLevel: userData?.recoveryLevel || \"NONE\",\r\n    totalExperience: titanState?.xp || userData?.totalExperience || 0,\r\n\r\n    weeklyMastery: initialData.weeklyMastery,\r\n    cardioMode: \"cycling\", // Default\r\n    returnView: null,\r\n    faction: (faction as Faction) || \"HORDE\",\r\n    challenges: challenges || [],\r\n    activeDuel: initialData.activeDuel || props.activeDuel,\r\n    trainingContext: initialData.trainingContext,\r\n  };\r\n\r\n  const [state, dispatch] = useReducer(dashboardReducer, initialStateFromProps);\r\n  // const [isConfigured, setIsConfigured] = useState(false); // Removed gate logic\r\n  const [showOnboarding, setShowOnboarding] = useState(!hasCompletedOnboarding);\r\n  const router = useRouter();\r\n  const platform = usePlatformContext();\r\n  useEffect(() => {\r\n    dispatch({ type: \"UPDATE_CHALLENGES\", payload: challenges || [] });\r\n  }, [challenges, dispatch]);\r\n\r\n  // God Tier 2: Soundscapes\r\n  useAmbientSound(getAmbientZone(state.currentView));\r\n\r\n  /* Hevy API Configuration Gate Removed per user request */\r\n\r\n  const handleSaveWorkout = async (isPrivate: boolean) => {\r\n    if (!state.activeQuest || !state.startTime) return;\r\n\r\n    const apiKey = userData?.hevyApiKey || localStorage.getItem(\"hevy_api_key\");\r\n    if (!apiKey) {\r\n      toast.error(\"Access Denied\", {\r\n        description: \"You need a Hevy API Key to save quests.\",\r\n      });\r\n      router.push(\"/settings\");\r\n      return;\r\n    }\r\n\r\n    const payload = mapQuestToHevyPayload(\r\n      state.activeQuest,\r\n      state.questTitle,\r\n      state.startTime,\r\n      new Date(),\r\n      isPrivate,\r\n    );\r\n    try {\r\n      await saveWorkoutAction(apiKey, payload);\r\n      toast.success(\"Quest Log Updated!\", {\r\n        description: \"The Hevy Archive has explicitly recorded your victory.\",\r\n      });\r\n    } catch (error) {\r\n      console.error(\"Uplink to Hevy failed:\", error);\r\n      toast.warning(\"Loot Secured Locally\", {\r\n        description: \"Uplink to Hevy failed. Check console.\",\r\n      });\r\n    } finally {\r\n      const newProgression = await getProgressionAction();\r\n      if (newProgression) {\r\n        dispatch({\r\n          type: \"RECALCULATE_PROGRESSION\",\r\n          payload: { level: newProgression.level },\r\n        });\r\n      }\r\n      dispatch({ type: \"SAVE_WORKOUT\" });\r\n    }\r\n  };\r\n\r\n  // View rendering delegated to ViewRouter component\r\n  const viewRouterProps = {\r\n    state,\r\n    dispatch,\r\n    userData,\r\n    titanState,\r\n    pocketCastsConnected,\r\n    liteMode,\r\n    onSaveWorkout: handleSaveWorkout,\r\n    leaderboardEntries: leaderboardData, // Pass it down\r\n  };\r\n\r\n  const AnimatedViewWrapper = ({\r\n    children,\r\n    viewKey,\r\n  }: {\r\n    children: React.ReactNode;\r\n    viewKey: string;\r\n  }) => (\r\n    <motion.div\r\n      key={viewKey}\r\n      initial={{ opacity: 0, scale: 0.98, y: 10 }}\r\n      animate={{ opacity: 1, scale: 1, y: 0 }}\r\n      exit={{ opacity: 0, scale: 1.02 }}\r\n      transition={{ duration: 0.3, ease: [0.4, 0, 0.2, 1] }}\r\n      className=\"w-full\"\r\n    >\r\n      {children}\r\n    </motion.div>\r\n  );\r\n\r\n  /* Configuration Screen Removed */\r\n\r\n  if (state.isCodexLoading) return <main id=\"codex-loader\"><CodexLoader /></main>;\r\n\r\n  return (\r\n    <div id=\"main-content\" className=\"bg-forge-900 min-h-screen bg-noise\">\r\n      <div className=\"scanlines pointer-events-none fixed inset-0 z-50 opacity-5\" />\r\n\r\n      <PwaInstallBanner />\r\n\r\n      {platform === \"tv\" && (\r\n        <TvHud\r\n          questTitle={state.questTitle}\r\n          heartRate={state.wellnessData?.hrv} // Using HRV as a proxy for HR if HR not direct\r\n          bossName={state.activeBossId || undefined}\r\n        />\r\n      )}\r\n\r\n      <Link\r\n        href=\"/settings\"\r\n        className=\"fixed top-6 right-6 z-50 text-forge-muted hover:text-white transition-colors p-2 hover:rotate-90 duration-300\"\r\n        aria-label=\"Settings\"\r\n      >\r\n        <Settings size={24} />\r\n      </Link>\r\n\r\n      <PersistentHeader\r\n        level={state.level}\r\n        xp={state.totalExperience}\r\n        gold={userData?.gold || 0}\r\n        faction={state.faction}\r\n        powerRating={titanState?.powerRating || 0}\r\n      />\r\n\r\n      <AnimatePresence mode=\"wait\">\r\n        <AnimatedViewWrapper viewKey={state.currentView}>\r\n          <main id=\"view-container\">\r\n            <ViewRouter {...viewRouterProps} />\r\n          </main>\r\n        </AnimatedViewWrapper>\r\n      </AnimatePresence>\r\n\r\n      {showOnboarding && (\r\n        <FirstLoginQuest\r\n          onComplete={(newState) => {\r\n            setShowOnboarding(false);\r\n            if (newState) {\r\n              dispatch({\r\n                type: \"RECALCULATE_PROGRESSION\",\r\n                payload: { level: newState.level },\r\n              });\r\n            }\r\n          }}\r\n        />\r\n      )}\r\n\r\n      <CoachToggle onClick={() => dispatch({ type: \"TOGGLE_COACH\" })} />\r\n      <GeminiLiveCoach\r\n        isOpen={state.isCoachOpen}\r\n        onClose={() => dispatch({ type: \"TOGGLE_COACH\" })}\r\n      />\r\n\r\n      <OracleChat\r\n        context={{\r\n          userId: userData?.id || \"unknown\",\r\n          path: state.activePath,\r\n          wellness: state.wellnessData,\r\n          mastery: state.weeklyMastery,\r\n          indices: state.ttb,\r\n        }}\r\n      />\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default DashboardClient;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\alexa\\Workspaces\\IronForge\\src\\features\\game\\components\\ActionView.tsx","messages":[{"ruleId":"react/jsx-no-undef","severity":2,"message":"'Ban' is not defined.","line":454,"column":18,"nodeType":"JSXIdentifier","messageId":"undefined","endLine":454,"endColumn":21}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, {\n  useState,\n  useEffect,\n  useCallback,\n  useRef,\n  useContext,\n  memo,\n} from \"react\";\nimport {\n  Block,\n  Set as WorkoutSet,\n  ExerciseLogic,\n  IntervalsWellness,\n  AppSettings,\n  Exercise,\n} from \"@/types\";\nimport {\n  Check,\n  Info,\n  X,\n  Lock,\n  Zap,\n  Sword,\n  Shield,\n  Crown,\n  LogOut,\n  Flame,\n  Battery,\n  Mic,\n  Camera,\n  Waves,\n  ArrowUp,\n  ArrowDown,\n  Timer,\n  Plus,\n  Copy,\n} from \"lucide-react\";\nimport {\n  roundToPlates,\n  fireConfetti,\n  calculateRarity,\n  playSound,\n  calculateTitanRank,\n} from \"@/utils\";\nimport { calculateApre, ApreSuggestion } from \"@/utils/apre\";\nimport PlateVisualizer from \"@/features/strength/components/PlateVisualizer\";\nimport ExerciseLibrary from \"@/features/strength/components/ExerciseLibrary\";\nimport HeartRateMonitor from \"@/features/bio/components/HeartRateMonitor\";\nimport VisionRepCounter from \"@/features/training/components/VisionRepCounter\";\nimport { AchievementContext } from \"@/context/AchievementContext\";\nimport { useSkills } from \"@/context/SkillContext\";\nimport { IoTService } from \"@/services/iot\";\nimport { RaidService } from \"@/services/raid\";\nimport { NeuroService } from \"@/services/neuro\";\nimport { StorageService } from \"@/services/storage\";\nimport { useVoiceCommand } from \"@/hooks/useVoiceCommand\";\n\ninterface ActionViewProps {\n  block: Block;\n  onComplete: () => void;\n  onAbort: () => void;\n  bpm: number | null;\n  isBtConnected: boolean;\n  onBtConnect: () => void;\n  onBtSimulate: () => void;\n  btError?: string | null;\n  wellness: IntervalsWellness | null;\n  previousStats?: Record<\n    string,\n    { weight: number; reps: number; e1rm: number }\n  >;\n  onSessionUpdate?: (exercises: Exercise[]) => void; // Persistence Callback\n}\n\ninterface SetRowProps {\n  set: WorkoutSet;\n  exIndex: number;\n  setIndex: number;\n  isFocused: boolean;\n  isLocked: boolean;\n  displayWeight: number;\n  isLandmine: boolean;\n  rarity: string;\n  onToggle: (exIdx: number, setIdx: number) => void;\n  onRepsChange: (exIdx: number, setIdx: number, newReps: number) => void;\n  onWeightChange: (exIdx: number, setIdx: number, newWeight: number) => void;\n  onRpeChange: (exIdx: number, setIdx: number, newRpe: number) => void;\n  activeSetRef: React.RefObject<HTMLDivElement | null> | null;\n  previous?: { weight: number; reps: number; e1rm: number };\n}\n\nconst SetRow = memo(\n  ({\n    set,\n    exIndex,\n    setIndex,\n    isFocused,\n    isLocked,\n    displayWeight,\n    isLandmine,\n    rarity,\n    onToggle,\n    onRepsChange,\n    onWeightChange,\n    onRpeChange,\n    activeSetRef,\n    previous,\n  }: SetRowProps) => {\n    const getRarityBorder = (rarity: string) => {\n      switch (rarity) {\n        case \"poor\":\n          return \"border-rarity-poor shadow-none opacity-50\";\n        case \"common\":\n          return \"border-rarity-common/50 shadow-none\";\n        case \"uncommon\":\n          return \"border-rarity-uncommon shadow-[0_0_10px_rgba(30,255,0,0.1)]\";\n        case \"rare\":\n          return \"border-rarity-rare shadow-[0_0_15px_rgba(0,112,221,0.2)]\";\n        case \"epic\":\n          return \"border-rarity-epic shadow-[0_0_20px_rgba(163,53,238,0.3)]\";\n        case \"legendary\":\n          return \"border-rarity-legendary shadow-[0_0_25px_rgba(255,128,0,0.4)]\";\n        default:\n          return \"border-zinc-800\";\n      }\n    };\n\n    const getRarityText = (rarity: string) => {\n      switch (rarity) {\n        case \"poor\":\n          return \"text-rarity-poor\";\n        case \"common\":\n          return \"text-rarity-common\";\n        case \"uncommon\":\n          return \"text-rarity-uncommon\";\n        case \"rare\":\n          return \"text-rarity-rare\";\n        case \"epic\":\n          return \"text-rarity-epic\";\n        case \"legendary\":\n          return \"text-rarity-legendary\";\n        default:\n          return \"text-zinc-500\";\n      }\n    };\n\n    const borderColor = getRarityBorder(rarity);\n    const textColor = getRarityText(rarity);\n    const isAmrap = typeof set.reps === \"string\";\n    const inputValue =\n      set.completedReps !== undefined\n        ? set.completedReps\n        : isAmrap\n          ? \"\"\n          : set.reps;\n\n    // --- COMPACT VIEW (Completed Sets) ---\n    if (set.completed) {\n      return (\n        <div\n          className={`flex items-center justify-between p-2 bg-zinc-950/50 border border-zinc-900 rounded-md opacity-70 transition-all hover:opacity-100 cursor-pointer`}\n          onClick={() => onToggle(exIndex, setIndex)}\n        >\n          <div className=\"flex items-center gap-3\">\n            <div className=\"bg-green-900/30 p-1 rounded-full border border-green-900\">\n              <Check className=\"w-3 h-3 text-green-500\" />\n            </div>\n            <div className=\"flex flex-col\">\n              <span className=\"text-xs font-bold text-zinc-500 uppercase tracking-wider\">\n                Set {setIndex + 1}\n              </span>\n              <div className=\"flex items-center gap-2 text-sm font-mono text-zinc-300\">\n                <span className=\"font-bold text-white\">\n                  {set.completedReps}\n                </span>{\" \"}\n                reps\n                <span className=\"text-zinc-600\">@</span>\n                <span>{displayWeight > 0 ? `${displayWeight}kg` : \"BW\"}</span>\n              </div>\n            </div>\n          </div>\n          {set.rarity && set.rarity !== \"common\" && (\n            <span\n              className={`text-[9px] uppercase font-bold px-2 py-0.5 border rounded-full ${getRarityText(set.rarity)} border-current opacity-60`}\n            >\n              {set.rarity}\n            </span>\n          )}\n        </div>\n      );\n    }\n\n    // --- EXPANDED VIEW (Active/Pending) ---\n    return (\n      <div\n        ref={activeSetRef}\n        className={`group relative bg-[#0a0a0a] border-2 rounded-lg overflow-hidden transition-all duration-300 \n              ${isFocused ? `scale-[1.02] z-10 shadow-xl ${borderColor}` : `border-zinc-900 hover:border-zinc-700`}\n            `}\n      >\n        <div className={`flex flex-col gap-3 ${isFocused ? \"p-6\" : \"p-4\"}`}>\n          {/* Header Row */}\n          <div className=\"flex justify-between items-start\">\n            <div className=\"flex flex-col\">\n              <div className=\"flex items-center gap-2 mb-1\">\n                <span\n                  className={`text-xs font-serif uppercase font-bold ${isFocused ? \"text-zinc-300\" : \"text-zinc-600\"}`}\n                >\n                  Objective {setIndex + 1}\n                </span>\n                {rarity === \"epic\" && !set.completed && (\n                  <span className=\"text-[10px] font-bold px-1.5 py-0.5 rounded uppercase tracking-wider text-rarity-epic border border-rarity-epic/30 bg-rarity-epic/10 animate-pulse\">\n                    Epic Loot\n                  </span>\n                )}\n              </div>\n\n              {/* Stats Row */}\n              <div className=\"flex flex-col gap-2 mt-2\">\n                {/* Previous Params Ghost */}\n                {isFocused && previous && previous.e1rm > 0 && (\n                  <div className=\"text-[10px] text-zinc-500 font-mono flex items-center gap-2 mb-1\">\n                    <span className=\"uppercase tracking-widest text-zinc-600\">\n                      Last:\n                    </span>\n                    {previous.weight > 0 ? (\n                      <>\n                        <span>\n                          {previous.weight}kg x {previous.reps}\n                        </span>\n                        <span className=\"text-zinc-700\">|</span>\n                      </>\n                    ) : null}\n                    <span>e1RM: {previous.e1rm}</span>\n                    <button\n                      onClick={(e) => {\n                        e.stopPropagation();\n                        if (previous.weight > 0)\n                          onWeightChange(exIndex, setIndex, previous.weight);\n                        if (previous.reps > 0)\n                          onRepsChange(exIndex, setIndex, previous.reps);\n                        playSound(\"ding\");\n                      }}\n                      className=\"ml-2 p-0.5 hover:bg-zinc-800 rounded text-zinc-600 hover:text-indigo-400 transition-colors\"\n                      title=\"Copy Last Set\"\n                    >\n                      <Copy className=\"w-3 h-3\" />\n                    </button>\n                  </div>\n                )}\n\n                <div className=\"flex items-end gap-4\">\n                  {/* REPS INPUT */}\n                  <div className=\"flex flex-col items-center\">\n                    {isFocused ? (\n                      <>\n                        <div className=\"flex items-center gap-2\">\n                          <button\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              onRepsChange(\n                                exIndex,\n                                setIndex,\n                                Math.max(\n                                  0,\n                                  (set.completedReps ||\n                                    (typeof set.reps === \"number\"\n                                      ? set.reps\n                                      : 0) ||\n                                    0) - 1,\n                                ),\n                              );\n                            }}\n                            className=\"w-8 h-8 rounded-full bg-zinc-800 text-zinc-400 hover:bg-zinc-700 flex items-center justify-center font-bold\"\n                          >\n                            -\n                          </button>\n                          <input\n                            type=\"number\"\n                            value={inputValue}\n                            placeholder={isAmrap ? \"MAX\" : String(set.reps)}\n                            onChange={(e) =>\n                              onRepsChange(\n                                exIndex,\n                                setIndex,\n                                parseInt(e.target.value) || 0,\n                              )\n                            }\n                            onClick={(e) => e.stopPropagation()}\n                            className=\"w-16 bg-zinc-900 border-b-2 border-zinc-500 text-white text-3xl font-serif font-bold text-center p-0 rounded-none focus:border-[#c79c6e] focus:outline-none placeholder-zinc-700\"\n                          />\n                          <button\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              onRepsChange(\n                                exIndex,\n                                setIndex,\n                                (set.completedReps ||\n                                  (typeof set.reps === \"number\"\n                                    ? set.reps\n                                    : 0) ||\n                                  0) + 1,\n                              );\n                            }}\n                            className=\"w-8 h-8 rounded-full bg-zinc-800 text-zinc-400 hover:bg-zinc-700 flex items-center justify-center font-bold\"\n                          >\n                            +\n                          </button>\n                        </div>\n                        <span className=\"text-zinc-500 text-[9px] uppercase font-bold tracking-widest mt-1\">\n                          Reps\n                        </span>\n                      </>\n                    ) : (\n                      <div className=\"flex items-baseline gap-1\">\n                        <span className=\"text-2xl font-serif font-bold text-white\">\n                          {isAmrap ? \"AMRAP\" : set.reps}\n                        </span>\n                        <span className=\"text-zinc-600 text-xs font-bold uppercase\">\n                          reps\n                        </span>\n                      </div>\n                    )}\n                  </div>\n\n                  {/* WEIGHT INPUT */}\n                  <div className=\"flex flex-col items-center\">\n                    {isFocused ? (\n                      <>\n                        <div className=\"flex items-center gap-2\">\n                          <button\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              onWeightChange(\n                                exIndex,\n                                setIndex,\n                                Math.max(0, displayWeight - 2.5),\n                              );\n                            }}\n                            className=\"w-8 h-8 rounded-full bg-zinc-800 text-zinc-400 hover:bg-zinc-700 flex items-center justify-center font-bold\"\n                          >\n                            -\n                          </button>\n                          <input\n                            type=\"number\"\n                            value={displayWeight}\n                            onChange={(e) =>\n                              onWeightChange(\n                                exIndex,\n                                setIndex,\n                                parseFloat(e.target.value) || 0,\n                              )\n                            }\n                            onClick={(e) => e.stopPropagation()}\n                            className=\"w-20 bg-zinc-900 border-b-2 border-zinc-500 text-white text-3xl font-serif font-bold text-center p-0 rounded-none focus:border-blue-500 focus:outline-none\"\n                          />\n                          <button\n                            onClick={(e) => {\n                              e.stopPropagation();\n                              onWeightChange(\n                                exIndex,\n                                setIndex,\n                                displayWeight + 2.5,\n                              );\n                            }}\n                            className=\"w-8 h-8 rounded-full bg-zinc-800 text-zinc-400 hover:bg-zinc-700 flex items-center justify-center font-bold\"\n                          >\n                            +\n                          </button>\n                        </div>\n                        <span className=\"text-zinc-500 text-[9px] uppercase font-bold tracking-widest mt-1\">\n                          KG Load\n                        </span>\n                      </>\n                    ) : (\n                      <div className=\"flex flex-col items-center ml-2\">\n                        <span\n                          className={`font-mono font-bold ${isFocused ? \"text-2xl\" : \"text-lg\"} ${textColor}`}\n                        >\n                          {displayWeight > 0 ? `${displayWeight}` : \"BW\"}\n                        </span>\n                        <span className=\"text-zinc-600 text-[10px] uppercase font-bold tracking-widest\">\n                          Weight\n                        </span>\n                      </div>\n                    )}\n                  </div>\n\n                  {/* RPE INPUT (Only when focused) */}\n                  {isFocused && (\n                    <div className=\"flex flex-col items-center ml-2 animate-fade-in-left\">\n                      <div className=\"bg-zinc-900 p-1 rounded-lg border border-zinc-800 flex flex-col items-center\">\n                        <input\n                          type=\"number\"\n                          max={10}\n                          min={1}\n                          step={0.5}\n                          value={set.rpe || \"\"}\n                          placeholder=\"-\"\n                          onChange={(e) =>\n                            onRpeChange(\n                              exIndex,\n                              setIndex,\n                              parseFloat(e.target.value),\n                            )\n                          }\n                          onClick={(e) => e.stopPropagation()}\n                          className=\"w-10 bg-transparent text-center text-yellow-500 font-bold text-xl focus:outline-none\"\n                        />\n                        <span className=\"text-[8px] text-zinc-500 uppercase font-bold\">\n                          RPE\n                        </span>\n                      </div>\n                    </div>\n                  )}\n                </div>\n              </div>\n            </div>\n\n            {/* Action Button */}\n            <button\n              onClick={() => onToggle(exIndex, setIndex)}\n              disabled={isLocked}\n              className={`rounded-xl flex items-center justify-center transition-all shadow-lg active:scale-95\n                          ${isLocked\n                  ? \"bg-red-950/10 border-2 border-red-900/50 text-red-900 cursor-not-allowed h-12 w-12\"\n                  : isFocused\n                    ? \"bg-zinc-100 text-black h-16 w-16 hover:bg-white hover:scale-105 shadow-[0_0_20px_rgba(255,255,255,0.1)]\" // Giant button for active\n                    : \"bg-zinc-900 border border-zinc-700 text-zinc-500 h-12 w-12 hover:border-zinc-500 hover:text-zinc-300\"\n                }`}\n            >\n              {isLocked ? (\n                <Lock className=\"w-5 h-5 animate-pulse\" />\n              ) : (\n                <Shield\n                  className={`${isFocused ? \"w-8 h-8 fill-current\" : \"w-5 h-5\"}`}\n                />\n              )}\n            </button>\n          </div>\n\n          {/* Footer / Visualizer */}\n          <div className=\"mt-1\">\n            {displayWeight > 20 &&\n              !isLocked &&\n              (isFocused || !set.completed) && (\n                <PlateVisualizer\n                  weight={displayWeight}\n                  isSingleLoaded={isLandmine}\n                />\n              )}\n            {isLocked && (\n              <div className=\"mt-2 p-2 bg-red-950/30 border border-red-900/50 rounded flex items-center gap-2\">\n                <Ban className=\"w-4 h-4 text-red-500 animate-pulse\" />\n                <span className=\"text-xs font-bold text-red-400 uppercase tracking-widest\">\n                  Aggro High: Recover HR\n                </span>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    );\n  },\n  (prev, next) => {\n    return (\n      prev.set.completed === next.set.completed &&\n      prev.set.completedReps === next.set.completedReps &&\n      prev.set.rarity === next.set.rarity &&\n      prev.isFocused === next.isFocused &&\n      prev.isLocked === next.isLocked &&\n      prev.displayWeight === next.displayWeight &&\n      prev.set.rpe === next.set.rpe &&\n      prev.previous === next.previous\n    );\n  },\n);\n\nSetRow.displayName = \"SetRow\";\n\nconst ActionView: React.FC<ActionViewProps> = ({\n  block,\n  onComplete,\n  onAbort,\n  bpm,\n  isBtConnected,\n  onBtConnect,\n  onBtSimulate,\n  btError,\n  wellness,\n  previousStats = {},\n  onSessionUpdate,\n}) => {\n  const [exercises, setExercises] = useState(block.exercises || []);\n  const [openInfoId, setOpenInfoId] = useState<string | null>(null);\n  const [showVision, setShowVision] = useState(false);\n  const [cursor, setCursor] = useState<[number, number]>([0, 0]);\n  const [criticalHit, setCriticalHit] = useState<{\n    show: boolean;\n    msg: string;\n  }>({ show: false, msg: \"\" });\n  const [apreSuggestion, setApreSuggestion] = useState<ApreSuggestion | null>(\n    null,\n  );\n\n  // Game State\n  const [mana, setMana] = useState(wellness?.bodyBattery || 50);\n  const maxMana = 100;\n  const [manaDrain, setManaDrain] = useState<{ show: boolean; amount: number }>(\n    { show: false, amount: 0 },\n  );\n  const [isNeuroActive, setIsNeuroActive] = useState(false);\n\n  // REST TIMER STATE\n  const [restTimer, setRestTimer] = useState(0);\n  const [isResting, setIsResting] = useState(false);\n\n  const achievementContext = useContext(AchievementContext);\n  const { purchasedSkillIds } = useSkills();\n  const unlockedIds = achievementContext?.unlockedIds || new Set();\n  const { isElite } = calculateTitanRank(unlockedIds);\n  const hasPrimalRoar = purchasedSkillIds.has(\"beast_1\");\n\n  // --- NEURO LINK LOGIC ---\n  useEffect(() => {\n    if (isNeuroActive) {\n      if (bpm && bpm < 120) NeuroService.engageRecovery();\n      else NeuroService.engageFocus();\n    } else {\n      NeuroService.stop();\n    }\n    return () => NeuroService.stop();\n  }, [isNeuroActive, bpm]);\n\n  // --- PERSISTENCE: Propagate state up whenever it changes ---\n  useEffect(() => {\n    if (onSessionUpdate) {\n      onSessionUpdate(exercises);\n    }\n  }, [exercises, onSessionUpdate]);\n\n  // --- REST TIMER LOGIC ---\n  useEffect(() => {\n    let interval: any;\n    if (isResting) {\n      interval = setInterval(() => {\n        setRestTimer((prev) => prev + 1);\n      }, 1000);\n    } else {\n      setRestTimer(0);\n    }\n    return () => clearInterval(interval);\n  }, [isResting]);\n\n  const handleSkipRest = () => {\n    setIsResting(false);\n    setRestTimer(0);\n  };\n\n  const [heroName, setHeroName] = useState(\"Titan\");\n  useEffect(() => {\n    IoTService.init();\n    StorageService.getState<AppSettings>(\"settings\").then((s) => {\n      if (s?.heroName) setHeroName(s.heroName);\n    });\n  }, []);\n\n  // Initial Cursor Position - Find first incomplete\n  useEffect(() => {\n    let found = false;\n    for (let i = 0; i < exercises.length; i++) {\n      for (let j = 0; j < exercises[i].sets.length; j++) {\n        if (!exercises[i].sets[j].completed) {\n          setCursor([i, j]);\n          found = true;\n          break;\n        }\n      }\n      if (found) break;\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []); // Only on mount\n\n  useEffect(() => {\n    if (!isBtConnected) return;\n    if (bpm && bpm > 160) IoTService.triggerRedAlert();\n    else if (bpm && bpm < 120) IoTService.triggerRecovery();\n    else IoTService.triggerFocus();\n  }, [bpm, isBtConnected]);\n\n  useEffect(() => {\n    if (criticalHit.show) {\n      const t = setTimeout(\n        () => setCriticalHit({ show: false, msg: \"\" }),\n        2000,\n      );\n      return () => clearTimeout(t);\n    }\n  }, [criticalHit.show]);\n\n  useEffect(() => {\n    if (manaDrain.show) {\n      const t = setTimeout(\n        () => setManaDrain({ show: false, amount: 0 }),\n        1000,\n      );\n      return () => clearTimeout(t);\n    }\n  }, [manaDrain.show]);\n\n  const activeSetRef = useRef<HTMLDivElement>(null);\n  useEffect(() => {\n    if (activeSetRef.current)\n      activeSetRef.current.scrollIntoView({\n        behavior: \"smooth\",\n        block: \"center\",\n      });\n  }, [cursor]);\n\n  const isSystemOverheated = bpm !== null && bpm > 120;\n  const isBlockComplete = exercises.every((ex) =>\n    ex.sets.every((s) => s.completed),\n  );\n  const isManaEmpty = mana <= 0;\n\n  const handleRepsChange = useCallback(\n    (exIndex: number, setIndex: number, newReps: number) => {\n      setExercises((prev) => {\n        const newExercises = [...prev];\n        const newSet = { ...newExercises[exIndex].sets[setIndex] };\n        newSet.completedReps = newReps;\n        newExercises[exIndex].sets[setIndex] = newSet;\n        return newExercises;\n      });\n    },\n    [],\n  );\n\n  const handleWeightChange = useCallback(\n    (exIndex: number, setIndex: number, newWeight: number) => {\n      setExercises((prev) => {\n        const newExercises = [...prev];\n        const newSet = { ...newExercises[exIndex].sets[setIndex] };\n        newSet.weight = newWeight;\n        // Also update percent if applicable, relative to TM? simpler to just set absolute weight for now\n        // If it was logic based, we might break the logic link, but user override is king.\n        newExercises[exIndex].sets[setIndex] = newSet;\n        return newExercises;\n      });\n    },\n    [],\n  );\n\n  const handleRpeChange = useCallback(\n    (exIndex: number, setIndex: number, newRpe: number) => {\n      setExercises((prev) => {\n        const newExercises = [...prev];\n        const newSet = { ...newExercises[exIndex].sets[setIndex] };\n        newSet.rpe = newRpe;\n        newExercises[exIndex].sets[setIndex] = newSet;\n        return newExercises;\n      });\n    },\n    [],\n  );\n\n  const handleToggleSet = useCallback(\n    (exIndex: number, setIndex: number) => {\n      setExercises((prev) => {\n        const newExercises = [...prev];\n        const exercise = newExercises[exIndex];\n        const newSet = { ...exercise.sets[setIndex] };\n\n        let weight = newSet.weight || 0;\n        if (\n          exercise.logic === ExerciseLogic.TM_PERCENT &&\n          exercise.trainingMax &&\n          newSet.weightPct\n        ) {\n          weight = roundToPlates(exercise.trainingMax * newSet.weightPct);\n        }\n\n        if (!newSet.completed && isSystemOverheated) {\n          playSound(\"fail\");\n          return prev;\n        }\n\n        if (!newSet.completed) {\n          // MARKING AS COMPLETE\n          if (\n            newSet.completedReps === undefined ||\n            newSet.completedReps === 0\n          ) {\n            if (typeof newSet.reps === \"number\")\n              newSet.completedReps = newSet.reps;\n          }\n          newSet.rarity = calculateRarity(newSet, exercise.logic);\n\n          // Trigger Rest Timer\n          setIsResting(true);\n\n          // --- APRE LOGIC ---\n          if (setIndex < exercise.sets.length - 1) {\n            const nextSet = exercise.sets[setIndex + 1];\n            if (\n              exercise.logic === ExerciseLogic.TM_PERCENT &&\n              exercise.trainingMax &&\n              nextSet.weightPct\n            ) {\n              const currentSetWeight = weight;\n              const rpe = 8;\n              const suggestion = calculateApre(\n                currentSetWeight,\n                newSet.completedReps || 0,\n                rpe,\n              );\n              if (suggestion) setApreSuggestion(suggestion);\n            }\n          }\n        } else {\n          // UN-COMPLETING\n          setIsResting(false);\n          setRestTimer(0);\n        }\n\n        newSet.completed = !newSet.completed;\n        newExercises[exIndex].sets[setIndex] = newSet;\n\n        if (newSet.completed) {\n          let cost = 5;\n          if (newSet.weightPct && newSet.weightPct > 0.8) cost = 10;\n          if (typeof newSet.reps === \"string\") cost = 15;\n          setMana((m) => Math.max(0, m - cost));\n          setManaDrain({ show: true, amount: cost });\n\n          const damage = Math.floor(weight * (newSet.completedReps || 1));\n          RaidService.broadcastDamage(heroName, damage, exercise.name);\n\n          if (newSet.isPrZone) IoTService.triggerRedAlert();\n          else IoTService.triggerVictory();\n\n          if (exercise.id === \"ex_belt_squat\" && weight >= 140)\n            achievementContext?.unlockAchievement(\"deep_squat_dynasty\");\n          if (exercise.id === \"ex_landmine_press\" && weight >= 100)\n            achievementContext?.unlockAchievement(\"perfect_plates\");\n\n          if (\n            newSet.rarity === \"legendary\" ||\n            newSet.rarity === \"epic\" ||\n            newSet.rarity === \"rare\"\n          ) {\n            if (\n              typeof newSet.reps === \"string\" ||\n              (newSet.completedReps &&\n                newSet.reps &&\n                newSet.completedReps > newSet.reps)\n            ) {\n              setCriticalHit({\n                show: true,\n                msg: `${newSet.rarity.toUpperCase()} Performance!`,\n              });\n              playSound(\"loot_epic\");\n              fireConfetti();\n            } else playSound(\"ding\");\n          } else playSound(\"ding\");\n        }\n        return newExercises;\n      });\n\n      // Auto-advance cursor if completing\n      const currentSetStatus = exercises[exIndex].sets[setIndex].completed;\n      // Logic note: we are using stale state 'exercises' here, but it's OK for logic direction\n      if (!currentSetStatus) {\n        if (setIndex < exercises[exIndex].sets.length - 1)\n          setCursor([exIndex, setIndex + 1]);\n        else if (exIndex < exercises.length - 1) setCursor([exIndex + 1, 0]);\n      }\n    },\n    [isSystemOverheated, achievementContext, heroName, exercises],\n  );\n\n  // --- VISION ---\n  const handleVisionRep = useCallback(() => {\n    const [exIndex, setIndex] = cursor;\n    const currentSet = exercises[exIndex].sets[setIndex];\n    const currentReps = currentSet.completedReps || 0;\n    handleRepsChange(exIndex, setIndex, currentReps + 1);\n    playSound(\"ding\");\n  }, [cursor, exercises, handleRepsChange]);\n\n  // --- VOICE ---\n  const handleVoiceCommand = useCallback(\n    (type: string, value: number | string) => {\n      const [exIndex, setIndex] = cursor;\n      if (type === \"REPS\") handleRepsChange(exIndex, setIndex, value as number);\n      else if (type === \"COMPLETE\") handleToggleSet(exIndex, setIndex);\n    },\n    [cursor, handleRepsChange, handleToggleSet],\n  );\n\n  const { isListening, toggleListening, lastCommand } =\n    useVoiceCommand(handleVoiceCommand);\n\n  const handleApplyApre = () => {\n    if (!apreSuggestion) return;\n    const [exIdx, setIdx] = cursor;\n\n    setExercises((prev) => {\n      const next = [...prev];\n      const ex = next[exIdx];\n      const nextSetIdx = ex.sets.findIndex(\n        (s, i) => !s.completed && i > setIdx,\n      ); // Find next active\n\n      if (nextSetIdx !== -1) {\n        const newWeight = apreSuggestion.newWeight;\n        if (ex.trainingMax) {\n          ex.sets[nextSetIdx].weightPct = newWeight / ex.trainingMax;\n          ex.sets[nextSetIdx].weight = newWeight;\n        }\n      }\n      return next;\n    });\n    setApreSuggestion(null);\n    playSound(\"quest_accept\");\n  };\n\n  const stateRef = useRef({\n    exercises,\n    cursor,\n    isSystemOverheated,\n    isBlockComplete,\n    isManaEmpty,\n  });\n  useEffect(() => {\n    stateRef.current = {\n      exercises,\n      cursor,\n      isSystemOverheated,\n      isBlockComplete,\n      isManaEmpty,\n    };\n  }, [exercises, cursor, isSystemOverheated, isBlockComplete, isManaEmpty]);\n\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if (e.target instanceof HTMLInputElement) return;\n      const {\n        exercises: currExercises,\n        cursor: currCursor,\n        isSystemOverheated: currOverheated,\n        isBlockComplete: currComplete,\n        isManaEmpty: currManaEmpty,\n      } = stateRef.current;\n      const [exIdx, setIdx] = currCursor;\n\n      if (e.code === \"ArrowDown\" || e.code === \"KeyS\") {\n        e.preventDefault();\n        if (setIdx < currExercises[exIdx].sets.length - 1)\n          setCursor([exIdx, setIdx + 1]);\n        else if (exIdx < currExercises.length - 1) setCursor([exIdx + 1, 0]);\n      } else if (e.code === \"ArrowUp\" || e.code === \"KeyW\") {\n        e.preventDefault();\n        if (setIdx > 0) setCursor([exIdx, setIdx - 1]);\n        else if (exIdx > 0)\n          setCursor([exIdx - 1, currExercises[exIdx - 1].sets.length - 1]);\n      } else if (\n        e.code === \"Space\" ||\n        e.code === \"Enter\" ||\n        e.code === \"ArrowRight\" ||\n        e.code === \"KeyD\"\n      ) {\n        e.preventDefault();\n        if (\n          e.code === \"Enter\" &&\n          currComplete &&\n          !currOverheated &&\n          !currManaEmpty\n        ) {\n          playSound(\"ding\");\n          onComplete();\n          return;\n        }\n        handleToggleSet(exIdx, setIdx);\n      }\n    };\n    window.addEventListener(\"keydown\", handleKeyDown);\n    return () => window.removeEventListener(\"keydown\", handleKeyDown);\n  }, [handleToggleSet, onComplete]);\n\n  const manaPct = (mana / maxMana) * 100;\n  let manaColor = \"bg-blue-500\";\n  if (manaPct < 30) manaColor = \"bg-orange-500\";\n  if (manaPct < 10) manaColor = \"bg-red-600 animate-pulse\";\n  const isRested = (wellness?.sleepScore || 0) > 80;\n\n  const formatTime = (secs: number) => {\n    const m = Math.floor(secs / 60);\n    const s = secs % 60;\n    return `${m}:${s.toString().padStart(2, \"0\")}`;\n  };\n\n  return (\n    <div\n      className={`flex flex-col h-full bg-[#050505] transition-colors duration-500 relative ${!isSystemOverheated && bpm ? \"bg-green-950/5\" : \"\"}`}\n    >\n      {/* REST TIMER HUD */}\n      {isResting && (\n        <div className=\"fixed top-24 right-4 z-50 animate-slide-left\">\n          <div className=\"bg-[#111] border-2 border-zinc-700 rounded-lg p-3 shadow-[0_0_20px_rgba(0,0,0,0.8)] flex items-center gap-4\">\n            <div className=\"text-center\">\n              <div className=\"text-[10px] uppercase font-bold text-zinc-500 mb-1\">\n                Rest Timer\n              </div>\n              <div className=\"text-2xl font-mono font-bold text-white flex items-center gap-2\">\n                <Timer className=\"w-5 h-5 text-zinc-400\" />\n                {formatTime(restTimer)}\n              </div>\n            </div>\n            <button\n              onClick={handleSkipRest}\n              className=\"bg-zinc-800 hover:bg-zinc-700 text-white px-3 py-2 rounded text-xs font-bold uppercase\"\n            >\n              Ready\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* APRE TOAST */}\n      {apreSuggestion && (\n        <div className=\"fixed bottom-24 left-1/2 -translate-x-1/2 z-50 animate-slide-up w-80\">\n          <div className=\"bg-[#111] border-2 border-cyan-500 rounded-lg p-4 shadow-[0_0_20px_rgba(6,182,212,0.3)]\">\n            <div className=\"flex items-center gap-2 mb-2 text-cyan-400 font-bold uppercase text-xs tracking-widest\">\n              <Zap className=\"w-4 h-4\" /> Neuro-Optimization\n            </div>\n            <p className=\"text-zinc-300 text-xs mb-3\">\n              {apreSuggestion.reason}\n            </p>\n            <div className=\"flex gap-2\">\n              <button\n                onClick={handleApplyApre}\n                className=\"flex-1 bg-cyan-900/50 border border-cyan-500 text-cyan-300 hover:bg-cyan-800 text-xs font-bold py-2 rounded uppercase flex items-center justify-center gap-1\"\n              >\n                {apreSuggestion.type === \"INCREASE\" ? (\n                  <ArrowUp className=\"w-3 h-3\" />\n                ) : (\n                  <ArrowDown className=\"w-3 h-3\" />\n                )}\n                {apreSuggestion.adjustment > 0 ? \"+\" : \"\"}\n                {apreSuggestion.adjustment}kg\n              </button>\n              <button\n                onClick={() => setApreSuggestion(null)}\n                className=\"px-3 border border-zinc-700 text-zinc-500 hover:text-white rounded\"\n              >\n                <X className=\"w-4 h-4\" />\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* MANA BAR OVERLAY */}\n      <div className=\"absolute top-0 left-0 right-0 h-1 bg-zinc-900 z-50\">\n        <div\n          className={`h-full transition-all duration-500 ease-out ${manaColor} shadow-[0_0_10px_currentColor]`}\n          style={{ width: `${manaPct}%` }}\n        />\n      </div>\n\n      {lastCommand && (\n        <div className=\"fixed top-20 left-1/2 -translate-x-1/2 z-50 bg-black/80 border border-zinc-700 px-4 py-2 rounded text-xs font-mono text-green-400 animate-fade-in-out\">\n          &gt; {lastCommand}\n        </div>\n      )}\n\n      {manaDrain.show && (\n        <div className=\"fixed top-20 right-10 text-red-500 font-black text-2xl animate-float-up z-50 text-shadow-sm font-serif\">\n          -{manaDrain.amount} Mana\n        </div>\n      )}\n\n      {isManaEmpty && (\n        <div className=\"fixed inset-0 z-0 pointer-events-none bg-red-900/10 animate-pulse flex items-center justify-center\">\n          <div className=\"text-red-500/20 font-black text-9xl uppercase rotate-[-15deg]\">\n            Soul Burn\n          </div>\n        </div>\n      )}\n\n      {criticalHit.show && (\n        <div className=\"fixed inset-0 z-[60] flex items-center justify-center pointer-events-none\">\n          <div className=\"flex flex-col items-center animate-scale-bounce\">\n            <div\n              className=\"text-6xl font-black italic text-[#ffd700] uppercase tracking-tighter drop-shadow-[0_0_15px_rgba(255,215,0,0.8)] stroke-black\"\n              style={{ WebkitTextStroke: \"2px black\" }}\n            >\n              Critical Hit!\n            </div>\n            <div className=\"text-2xl font-bold text-white mt-2 bg-red-600 px-4 py-1 rounded skew-x-[-12deg] shadow-lg\">\n              {criticalHit.msg}\n            </div>\n          </div>\n        </div>\n      )}\n\n      <div className=\"px-6 py-4 border-b border-zinc-900 bg-zinc-950/80 flex justify-between items-center sticky top-0 z-10 backdrop-blur-md\">\n        <div>\n          <div className=\"flex items-center gap-2 mb-1\">\n            <span\n              className={`w-2 h-2 rotate-45 border ${isSystemOverheated ? \"border-orange-500 bg-orange-900\" : \"border-green-500 bg-green-900\"}`}\n            ></span>\n            <span\n              className={`${isSystemOverheated ? \"text-orange-500\" : \"text-green-500\"} font-serif text-xs uppercase tracking-widest`}\n            >\n              {isSystemOverheated ? \"Aggro High\" : \"Stealth Mode\"}\n            </span>\n          </div>\n          <h2 className=\"text-xl font-serif font-bold text-zinc-100 uppercase tracking-wide text-shadow-sm\">\n            {block.name}\n          </h2>\n        </div>\n\n        <div className=\"flex gap-4 items-center\">\n          <div className=\"hidden md:flex flex-col items-end\">\n            <div className=\"flex items-center gap-1 text-[10px] font-bold uppercase text-zinc-500\">\n              <Battery className=\"w-3 h-3\" /> Body Battery\n            </div>\n            <span\n              className={`font-mono font-bold text-lg ${manaPct < 30 ? \"text-red-500\" : \"text-blue-400\"}`}\n            >\n              {mana} / {maxMana}\n            </span>\n          </div>\n\n          <div className=\"h-8 w-px bg-zinc-800 hidden md:block\"></div>\n\n          <div className=\"flex gap-2\">\n            <button\n              onClick={() => setIsNeuroActive(!isNeuroActive)}\n              className={`p-2 border rounded transition-colors group relative ${isNeuroActive ? \"bg-purple-900/50 border-purple-500 text-purple-400\" : \"bg-zinc-900 border-zinc-800 text-zinc-400 hover:text-white\"}`}\n              title=\"Neuro-Link (Binaural Beats)\"\n            >\n              <Waves className=\"w-5 h-5\" />\n            </button>\n            <button\n              onClick={() => setShowVision(!showVision)}\n              className={`p-2 border rounded transition-colors group relative ${showVision ? \"bg-cyan-900/50 border-cyan-500 text-cyan-400\" : \"bg-zinc-900 border-zinc-800 text-zinc-400 hover:text-white\"}`}\n              title=\"Titan Vision (Rep Count)\"\n            >\n              <Camera className=\"w-5 h-5\" />\n            </button>\n            <button\n              onClick={toggleListening}\n              className={`p-2 border rounded transition-colors group relative ${isListening ? \"bg-red-900/50 border-red-500 text-red-400 animate-pulse\" : \"bg-zinc-900 border-zinc-800 text-zinc-400 hover:text-white\"}`}\n              title=\"Voice Commands\"\n            >\n              <Mic className=\"w-5 h-5\" />\n            </button>\n            <button\n              onClick={onAbort}\n              className=\"p-2 border border-red-900/30 bg-red-950/10 rounded text-red-700 hover:text-red-500 hover:border-red-600 transition-colors\"\n              title=\"Abandon Quest\"\n            >\n              <LogOut className=\"w-5 h-5\" />\n            </button>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"flex-1 overflow-y-auto p-4 md:p-6 space-y-8 scroll-smooth pb-32\">\n        <VisionRepCounter\n          isActive={showVision}\n          onRepCount={handleVisionRep}\n          onClose={() => setShowVision(false)}\n        />\n        <HeartRateMonitor\n          bpm={bpm}\n          isConnected={isBtConnected}\n          onConnect={onBtConnect}\n          onSimulate={onBtSimulate}\n          error={btError}\n          hasAura={isElite}\n        />\n\n        <div\n          className={`grid gap-6 ${exercises.length > 1 ? \"lg:grid-cols-2\" : \"grid-cols-1\"}`}\n        >\n          {exercises.map((ex, exIndex) => {\n            const isLandmine = ex.name.toLowerCase().includes(\"landmine\");\n            const isInfoOpen = openInfoId === ex.id;\n            const isAmrapEx = ex.sets.some((s) => typeof s.reps === \"string\");\n            const showPrimalRoar = hasPrimalRoar && isAmrapEx;\n\n            return (\n              <div key={ex.id} className=\"space-y-4\">\n                <div className=\"flex items-end justify-between border-b border-zinc-900 pb-2\">\n                  <div className=\"flex items-center gap-3\">\n                    <div className=\"p-2 bg-zinc-900 border border-zinc-800 rounded relative\">\n                      <Sword className=\"w-5 h-5 text-zinc-400\" />\n                      {showPrimalRoar && (\n                        <div className=\"absolute -top-1 -right-1 bg-red-500 rounded-full p-0.5 animate-pulse\">\n                          <Flame className=\"w-2 h-2 text-white fill-current\" />\n                        </div>\n                      )}\n                    </div>\n                    <div>\n                      <h3 className=\"text-lg font-serif font-bold text-zinc-200\">\n                        {ex.name}\n                      </h3>\n                      {showPrimalRoar && (\n                        <span className=\"text-[9px] font-bold uppercase text-red-500 tracking-wider flex items-center gap-1\">\n                          <Flame className=\"w-3 h-3\" /> Primal Roar Active\n                        </span>\n                      )}\n                    </div>\n                    <button\n                      onClick={() => setOpenInfoId(isInfoOpen ? null : ex.id)}\n                      className={`p-1 rounded hover:bg-zinc-800 transition-colors ${isInfoOpen ? \"text-rarity-epic\" : \"text-zinc-600\"}`}\n                    >\n                      <Info className=\"w-5 h-5\" />\n                    </button>\n                  </div>\n                  {ex.logic === ExerciseLogic.TM_PERCENT && (\n                    <span className=\"text-xs font-mono text-zinc-600\">\n                      TM: {ex.trainingMax}\n                    </span>\n                  )}\n                </div>\n\n                {isInfoOpen && (\n                  <div className=\"bg-[#111] border border-zinc-800 rounded p-4 text-sm animate-fade-in mb-4 shadow-xl\">\n                    {ex.instructions && (\n                      <ul className=\"space-y-2 mb-4\">\n                        {ex.instructions.map((inst, i) => (\n                          <li key={i} className=\"flex gap-2 text-zinc-400\">\n                            <span className=\"text-zinc-600 font-mono\">\n                              0{i + 1}.\n                            </span>\n                            <span className=\"font-serif italic\">{inst}</span>\n                          </li>\n                        ))}\n                      </ul>\n                    )}\n                  </div>\n                )}\n\n                <div className=\"space-y-3\">\n                  {ex.sets.map((set, setIndex) => {\n                    let displayWeight = set.weight || 0;\n                    if (\n                      ex.logic === ExerciseLogic.TM_PERCENT &&\n                      ex.trainingMax &&\n                      set.weightPct\n                    ) {\n                      displayWeight = roundToPlates(\n                        ex.trainingMax * set.weightPct,\n                      );\n                    }\n                    const isLocked = !set.completed && isSystemOverheated;\n                    const isFocused =\n                      cursor[0] === exIndex && cursor[1] === setIndex;\n                    const displayRarity =\n                      set.completed && set.rarity\n                        ? set.rarity\n                        : calculateRarity(set, ex.logic);\n\n                    return (\n                      <SetRow\n                        key={set.id}\n                        set={set}\n                        exIndex={exIndex}\n                        setIndex={setIndex}\n                        isFocused={isFocused}\n                        isLocked={isLocked}\n                        displayWeight={displayWeight}\n                        isLandmine={isLandmine}\n                        rarity={displayRarity}\n                        onToggle={handleToggleSet}\n                        onRepsChange={handleRepsChange}\n                        onWeightChange={handleWeightChange}\n                        onRpeChange={handleRpeChange}\n                        previous={previousStats[ex.id]} // Simplified: same previous for all sets of same exercise\n                        activeSetRef={isFocused ? activeSetRef : null}\n                      />\n                    );\n                  })}\n                </div>\n              </div>\n            );\n          })}\n        </div>\n\n        <div className=\"text-center text-zinc-700 text-xs font-serif uppercase tracking-widest mt-8 flex flex-col gap-3\">\n          <button\n            onClick={() => setOpenInfoId(\"ADD_EXERCISE\")} // repurposed for modal\n            className=\"flex items-center justify-center gap-2 py-3 px-6 bg-zinc-900 border border-zinc-800 rounded mx-auto hover:bg-zinc-800 hover:text-white transition-all text-zinc-500 font-bold w-full max-w-xs\"\n          >\n            <Plus className=\"w-4 h-4\" /> Add Exercise\n          </button>\n          <span>[ WASD Controls Active ]</span>\n        </div>\n      </div>\n\n      {/* EXERCISE LIBRARY MODAL */}\n      {openInfoId === \"ADD_EXERCISE\" && (\n        <div className=\"fixed inset-0 z-[100] animate-fade-in\">\n          <ExerciseLibrary\n            onSelect={(exId) => {\n              // Mock adding exercise logic - needing real exercise data lookup\n              // For now, we will just add a dummy \"New Exercise\" or fetch from Library logic\n              // Since ExerciseLibrary has mock data, we need to map it to our Exercise type\n\n              const newExercise: Exercise = {\n                id: exId + \"_\" + Date.now(),\n                name: \"New Exercise\", // Should get from library\n                logic: ExerciseLogic.FIXED_REPS,\n                sets: [\n                  {\n                    id: \"new_set_1\",\n                    reps: 10,\n                    weight: 20,\n                    completed: false,\n                    type: \"straight\",\n                  },\n                  {\n                    id: \"new_set_2\",\n                    reps: 10,\n                    weight: 20,\n                    completed: false,\n                    type: \"straight\",\n                  },\n                  {\n                    id: \"new_set_3\",\n                    reps: 10,\n                    weight: 20,\n                    completed: false,\n                    type: \"straight\",\n                  },\n                ],\n              };\n              setExercises((prev) => [...prev, newExercise]);\n              setOpenInfoId(null);\n              playSound(\"quest_accept\");\n            }}\n            onClose={() => setOpenInfoId(null)}\n          />\n        </div>\n      )}\n\n      <div className=\"p-6 bg-zinc-950 border-t border-zinc-900 sticky bottom-0 z-40\">\n        <div className=\"flex items-center justify-between mb-2 text-[10px] font-bold uppercase tracking-widest text-zinc-600\">\n          <span>Potential XP: {isRested ? \"Double (Rested)\" : \"Normal\"}</span>\n          <span>Mana Status: {isManaEmpty ? \"DEPLETED\" : \"Stable\"}</span>\n        </div>\n\n        <button\n          onClick={() => {\n            if (isBlockComplete && !isSystemOverheated && !isManaEmpty) {\n              playSound(\"ding\");\n              onComplete();\n            }\n          }}\n          disabled={!isBlockComplete || isSystemOverheated || isManaEmpty}\n          className={`w-full h-16 font-serif font-black text-xl uppercase tracking-widest rounded flex items-center justify-center gap-3 transition-all border-2 \n             ${isBlockComplete && !isSystemOverheated && !isManaEmpty\n              ? \"bg-rarity-legendary/10 border-rarity-legendary text-rarity-legendary hover:bg-rarity-legendary hover:text-white shadow-[0_0_30px_rgba(255,128,0,0.2)]\"\n              : \"bg-zinc-900 border-zinc-800 text-zinc-600 cursor-not-allowed\"\n            }`}\n        >\n          {isManaEmpty\n            ? \"Mana Depleted - Recover!\"\n            : isBlockComplete\n              ? isSystemOverheated\n                ? \"Wait for Aggro Drop\"\n                : \"Complete Quest Step\"\n              : \"Objectives Remaining\"}\n          {isBlockComplete && !isSystemOverheated && !isManaEmpty && (\n            <Crown className=\"w-6 h-6\" />\n          )}\n        </button>\n      </div>\n\n      <style>{`\n        @keyframes floatUp {\n            0% { transform: translateY(0); opacity: 1; }\n            100% { transform: translateY(-50px); opacity: 0; }\n        }\n        .animate-float-up {\n            animation: floatUp 1s ease-out forwards;\n        }\n        @keyframes fadeOut {\n            0% { opacity: 1; }\n            80% { opacity: 1; }\n            100% { opacity: 0; }\n        }\n        .animate-fade-in-out {\n            animation: fadeOut 2s forwards;\n        }\n        @keyframes slideLeft {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n        }\n        .animate-slide-left {\n            animation: slideLeft 0.3s ease-out forwards;\n        }\n      `}</style>\n    </div>\n  );\n};\n\nexport default ActionView;\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\alexa\\Workspaces\\IronForge\\src\\features\\strength\\components\\DungeonSessionView.tsx","messages":[{"ruleId":null,"fatal":true,"severity":2,"message":"Parsing error: Declaration or statement expected.","line":33,"column":0,"nodeType":null}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef, useMemo } from \"react\";\r\nimport { IntervalsWellness } from \"@/types\";\r\nimport { BioBuffService, BioBuff } from \"@/features/bio/BioBuffService\";\r\nimport { Exercise, Set as WorkoutSet } from \"@/types\";\r\nimport { playSound } from \"@/utils\";\r\nimport ExerciseView from \"@/features/training/components/ExerciseView\";\r\nimport ForgeButton from \"@/components/ui/ForgeButton\";\r\nimport { AnimatePresence } from \"framer-motion\";\r\nimport BerserkerMode from \"@/features/training/components/BerserkerMode\";\r\nimport BerserkerChoice from \"@/features/training/components/BerserkerChoice\";\r\nimport VisionRepCounter from \"@/features/training/components/VisionRepCounter\";\r\nimport { Eye, EyeOff } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\nimport { useJokerSets } from \"@/features/strength/hooks/useJokerSets\";\r\nimport { useSetLogging } from \"@/features/strength/hooks/useSetLogging\";\r\nimport { useVolumeTracking } from \"@/features/strength/hooks/useVolumeTracking\";\r\n\r\nimport { useRestTimer } from \"@/hooks/useRestTimer\";\r\nimport { RestTimer } from \"../RestTimer\";\r\nimport SupersetGroup from \"@/features/training/components/SupersetView\";\r\nimport { useHRRecoveryTimer } from \"@/features/strength/hooks/useHRRecoveryTimer\";\r\nimport { BiometricsHUD } from \"@/features/strength/components/BiometricsHUD\";\r\nimport { CardiacDriftWarning } from \"@/features/strength/components/CardiacDriftWarning\";\r\nimport { PRCelebration } from \"@/components/ui/PRCelebration\";\r\n\r\n\r\n\r\n// --- DUNGEON MODE IMPORTS ---\r\nimport DungeonInterface from \"@/components/game/dungeon/DungeonInterface\";\r\nimport ScreenShake from \"@/components/game/dungeon/ScreenShake\";\r\nimport BerserkerOverlay from \"@/components/game/dungeon/BerserkerOverlay\";\r\nimport OverchargePrompt from \"@/features/training/components/OverchargePrompt\";\r\n} from \"@/utils/combatMechanics\";\r\nimport { LiveSessionHUD } from \"@/features/coop/LiveSessionHUD\";\r\nimport { useUser } from \"@/hooks/useUser\";\r\nimport { contributeGuildDamageAction } from \"@/actions/guild/core\";\r\nimport { GhostOverlay } from \"@/features/coop/GhostOverlay\";\r\nimport { CoOpService, GhostEvent } from \"@/services/coop/CoOpService\";\r\n\r\ninterface IronMinesProps {\r\n  initialData: Exercise[];\r\n  title: string;\r\n  onComplete: () => void;\r\n  onAbort: () => void;\r\n  wellness?: IntervalsWellness | null;\r\n  hrvBaseline?: number;\r\n}\r\n\r\nconst DungeonSessionView: React.FC<IronMinesProps> = ({\r\n  initialData,\r\n  title,\r\n  onComplete,\r\n  onAbort,\r\n  wellness,\r\n  hrvBaseline = 50,\r\n}) => {\r\n  const { user } = useUser(); // Hook for Guild Damage\r\n  const [exercises, setExercises] = useState<Exercise[]>(() => {\r\n    // Try to load from local storage first\r\n    if (typeof window !== 'undefined') {\r\n      const saved = localStorage.getItem('iron_mines_session');\r\n      if (saved) {\r\n        try {\r\n          return JSON.parse(saved);\r\n        } catch (e) {\r\n          console.error(\"Failed to parse saved session\", e);\r\n        }\r\n      }\r\n    }\r\n    return initialData;\r\n  });\r\n\r\n  const [activeExIndex, setActiveExIndex] = useState(() => {\r\n    if (typeof window !== 'undefined') {\r\n      const saved = localStorage.getItem('iron_mines_index');\r\n      return saved ? parseInt(saved, 10) : 0;\r\n    }\r\n    return 0;\r\n  });\r\n\r\n  // Persist Changes\r\n  useEffect(() => {\r\n    localStorage.setItem('iron_mines_session', JSON.stringify(exercises));\r\n  }, [exercises]);\r\n\r\n  useEffect(() => {\r\n    localStorage.setItem('iron_mines_index', activeExIndex.toString());\r\n  }, [activeExIndex]);\r\n\r\n  // Clear on complete/abort\r\n  const clearSession = () => {\r\n    localStorage.removeItem('iron_mines_session');\r\n    localStorage.removeItem('iron_mines_index');\r\n  };\r\n\r\n  const [activeBuffs, setActiveBuffs] = useState<BioBuff[]>([]);\r\n\r\n  // Calculate Bio-Buffs\r\n  useEffect(() => {\r\n    const sleep = wellness?.sleepScore || 0;\r\n    const hrv = wellness?.hrv || 0;\r\n\r\n    // If no wellness data (e.g. demo mode or not synced), assume Stable\r\n    if (!wellness) {\r\n      // Fallback or \"Stable\"\r\n    }\r\n\r\n    const buff = BioBuffService.calculateBuff(sleep, hrv, hrvBaseline);\r\n    setActiveBuffs([buff]);\r\n\r\n    // Initialize HR Zones - will be handled in HR hook\r\n  }, [wellness, hrvBaseline]);\r\n\r\n  // Simulate HR Data (Demo Mode)\r\n  const { updateHR, metrics } = useHRRecoveryTimer();\r\n  useEffect(() => {\r\n    const interval = setInterval(() => {\r\n      // Simple sine wave simulation for demo\r\n      const time = Date.now() / 3000;\r\n      const base = 110;\r\n      const fluctuation = Math.sin(time) * 20;\r\n      updateHR(Math.floor(base + fluctuation));\r\n    }, 2000);\r\n    return () => clearInterval(interval);\r\n  }, [updateHR]);\r\n\r\n  // --- MODALS & TRIGGERS ---\r\n  const [showBerserkerChoice, setShowBerserkerChoice] = useState(false);\r\n  const [isBerserkerMode, setIsBerserkerMode] = useState(false);\r\n  const [questOver, setQuestOver] = useState(false);\r\n  const [isVisionActive, setIsVisionActive] = useState(false);\r\n\r\n  const activeRef = useRef<HTMLDivElement>(null);\r\n\r\n  // --- DUNGEON STATE ---\r\n  const [totalHp, setTotalHp] = useState(1);\r\n  const [damageDealt, setDamageDealt] = useState(0);\r\n  const [lastDamage, setLastDamage] = useState(0);\r\n  const [shakeTrigger, setShakeTrigger] = useState(0);\r\n\r\n  // --- GHOST MODE STATE ---\r\n  const [ghostEvents, setGhostEvents] = useState<GhostEvent[]>([]);\r\n  const [activeSessionId, setActiveSessionId] = useState<string | null>(null);\r\n\r\n  // Subscribe to Ghost Events (if in session)\r\n  useEffect(() => {\r\n    // E2E Test Support: Load mock ghost events\r\n    if (typeof window !== 'undefined' && (window as any).__mockGhostEvents) {\r\n      console.log(\"[DungeonSessionView] Loading mock ghost events\");\r\n      setGhostEvents((window as any).__mockGhostEvents);\r\n      // Simulate real-time updates for mocks? Not strictly needed if we just set initial state\r\n      return;\r\n    }\r\n\r\n    if (!activeSessionId) return;\r\n\r\n    const channel = CoOpService.subscribeToGhostEvents(activeSessionId, (event) => {\r\n      setGhostEvents(prev => [event, ...prev].slice(0, 10)); // Keep last 10\r\n      // Auto-clear after 5 seconds\r\n      setTimeout(() => {\r\n        setGhostEvents(prev => prev.filter(e => e.timestamp !== event.timestamp));\r\n      }, 5000);\r\n    });\r\n\r\n    return () => {\r\n      channel.unsubscribe();\r\n    };\r\n  }, [activeSessionId]);\r\n\r\n  // Initialize Boss HP\r\n  useEffect(() => {\r\n    const calculatedHp = exercises.reduce((acc, ex) => {\r\n      const weight = ex.trainingMax || 60;\r\n      const reps = ex.sets.reduce(\r\n        (rAcc, s) => rAcc + (typeof s.reps === \"number\" ? s.reps : 10),\r\n        0,\r\n      );\r\n      return acc + weight * reps;\r\n    }, 0);\r\n    setTotalHp(Math.max(calculatedHp, 1000));\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (activeRef.current) {\r\n      activeRef.current.scrollIntoView({ behavior: \"smooth\", block: \"center\" });\r\n    }\r\n  }, [activeExIndex]);\r\n\r\n  // --- HOOKS ---\r\n  const {\r\n    jokerPrompt,\r\n    checkJokerOpportunity,\r\n    handleJokerAccept,\r\n    handleJokerDecline,\r\n  } = useJokerSets(exercises, setExercises, activeExIndex);\r\n\r\n  const [showPRCelebration, setShowPRCelebration] = useState(false);\r\n  const [prData, setPrData] = useState<{ newReps: number; oldMax: number | null }>({ newReps: 0, oldMax: 0 });\r\n\r\n  const { handleSetLog } = useSetLogging(\r\n    exercises,\r\n    setExercises,\r\n    activeExIndex,\r\n    {\r\n      onDamage: (damage) => {\r\n        setDamageDealt((prev) => prev + damage);\r\n        setLastDamage(damage);\r\n        setShakeTrigger((prev) => prev + 1);\r\n\r\n        // --- GUILD ACTION ---\r\n        if (user?.id) {\r\n          contributeGuildDamageAction(user.id, damage).catch(e => console.error(\"Guild Action Failed\", e));\r\n\r\n          // --- GHOST BROADCAST ---\r\n          if (activeSessionId) {\r\n            CoOpService.broadcastGhostEvent(activeSessionId, {\r\n              type: 'SET_COMPLETE',\r\n              userId: user.id,\r\n              heroName: user.heroName || 'Hero',\r\n              damage,\r\n              timestamp: Date.now()\r\n            });\r\n          }\r\n        }\r\n      },\r\n      onJokerCheck: checkJokerOpportunity,\r\n      onExerciseComplete: () => setActiveExIndex((prev) => prev + 1),\r\n      onWorkoutComplete: () => setShowBerserkerChoice(true),\r\n      onRepPR: (newReps, oldMax) => {\r\n        setPrData({ newReps, oldMax });\r\n        setShowPRCelebration(true);\r\n      },\r\n    },\r\n  );\r\n\r\n  const { getVolumeFeedback } = useVolumeTracking(exercises);\r\n  const activeExerciseName = exercises[activeExIndex]?.name || \"\";\r\n  const volumeFeedback = getVolumeFeedback(activeExerciseName);\r\n\r\n  const handleVisionRep = () => {\r\n    setExercises((currentExercises) => {\r\n      const newExercises = [...currentExercises];\r\n      const currentEx = { ...newExercises[activeExIndex] };\r\n      const setIndex = currentEx.sets.findIndex((s) => !s.completed);\r\n\r\n      if (setIndex !== -1) {\r\n        const currentSets = [...currentEx.sets];\r\n        const targetSet = { ...currentSets[setIndex] };\r\n        targetSet.completedReps = (targetSet.completedReps || 0) + 1;\r\n        currentSets[setIndex] = targetSet;\r\n        currentEx.sets = currentSets;\r\n        newExercises[activeExIndex] = currentEx;\r\n        playSound(\"ding\");\r\n      }\r\n      return newExercises;\r\n    });\r\n  };\r\n\r\n  const handleNotesChange = (notes: string, exerciseIndex: number) => {\r\n    setExercises(current => {\r\n      const newEx = [...current];\r\n      newEx[exerciseIndex] = { ...newEx[exerciseIndex], notes };\r\n      return newEx;\r\n    });\r\n  };\r\n\r\n  const handleSetUpdate = (exerciseIndex: number, setIndex: number, updates: Partial<WorkoutSet>) => {\r\n    setExercises(current => {\r\n      const newEx = [...current];\r\n      const targetEx = { ...newEx[exerciseIndex] };\r\n      const targetSets = [...targetEx.sets];\r\n      targetSets[setIndex] = { ...targetSets[setIndex], ...updates };\r\n      targetEx.sets = targetSets;\r\n      newEx[exerciseIndex] = targetEx;\r\n      return newEx;\r\n    });\r\n  };\r\n\r\n  // --- BERSERKER (DROP SET) HANDLERS ---\r\n  const handleBerserkerAccept = () => {\r\n    setShowBerserkerChoice(false);\r\n    setIsBerserkerMode(true);\r\n  };\r\n\r\n  const handleBerserkerDecline = () => {\r\n    setShowBerserkerChoice(false);\r\n    setQuestOver(true);\r\n  };\r\n\r\n  const handleBerserkerComplete = (reps: number) => {\r\n    const weight = exercises[activeExIndex].sets[0].weight || 50;\r\n    const damage = weight * reps * 2;\r\n    setDamageDealt((prev) => prev + damage);\r\n    setLastDamage(damage);\r\n    setShakeTrigger((prev) => prev + 1);\r\n\r\n    setExercises((currentExercises) => {\r\n      const lastExerciseIndex = currentExercises.length - 1;\r\n      const berserkerSet: WorkoutSet = {\r\n        id: `berserker-${Date.now()}`,\r\n        completed: true,\r\n        weight: 0,\r\n        reps: reps,\r\n        completedReps: reps,\r\n        rpe: 10,\r\n        isPr: true,\r\n        rarity: \"legendary\",\r\n        e1rm: 0,\r\n      };\r\n\r\n      return currentExercises.map((exercise, index) => {\r\n        if (index === lastExerciseIndex) {\r\n          return {\r\n            ...exercise,\r\n            sets: [...exercise.sets, berserkerSet],\r\n          };\r\n        }\r\n        return exercise;\r\n      });\r\n    });\r\n\r\n    setIsBerserkerMode(false);\r\n    setQuestOver(true);\r\n  };\r\n\r\n  // --- DERIVED STATE ---\r\n  const { completedSets, totalSets } = useMemo(() => {\r\n    let completed = 0;\r\n    let total = 0;\r\n    exercises.forEach((ex) => {\r\n      total += ex.sets.length;\r\n      ex.sets.forEach((s) => {\r\n        if (s.completed) completed++;\r\n      });\r\n    });\r\n    return { completedSets: completed, totalSets: total };\r\n  }, [exercises]);\r\n\r\n  const isQuestFullyCompleted = useMemo(() => {\r\n    if (questOver) return true;\r\n    if (exercises.length === 0) return false;\r\n    const lastEx = exercises[exercises.length - 1];\r\n    const lastSet = lastEx.sets[lastEx.sets.length - 1];\r\n    return lastSet.type === \"AMRAP\" && lastSet.completed;\r\n  }, [exercises, questOver]);\r\n\r\n  const handleButtonClick = () => {\r\n    clearSession();\r\n    if (isQuestFullyCompleted) {\r\n      onComplete();\r\n    } else {\r\n      onAbort();\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"flex flex-col h-full w-full p-4 md:p-8 animate-fade-in gap-4 bg-[#0a0a0a]\">\r\n      {/* 1. HUD */}\r\n      <div className=\"flex-shrink-0 relative\">\r\n        <DungeonInterface\r\n          bossName={title || \"The Iron Keeper\"}\r\n          totalHp={totalHp}\r\n          currentHp={Math.max(0, totalHp - damageDealt)}\r\n          onDamage={lastDamage}\r\n          level={Math.floor(totalHp / 1000)}\r\n          buffs={activeBuffs}\r\n        />\r\n\r\n        {/* Volume Feedback (L1) */}\r\n        {volumeFeedback && (\r\n          <div className=\"absolute top-4 right-4 bg-black/60 backdrop-blur-md px-3 py-1.5 rounded-full border border-zinc-800 flex items-center gap-2 text-xs font-mono animate-fade-in z-20\">\r\n            <span\r\n              className={\r\n                volumeFeedback.status === \"OVER\"\r\n                  ? \"text-red-400\"\r\n                  : \"text-cyan-400\"\r\n              }\r\n            >\r\n              {volumeFeedback.muscleGroup}\r\n            </span>\r\n            <span className=\"text-zinc-500\">|</span>\r\n            <span className=\"text-white\">\r\n              {volumeFeedback.currentSets}/{volumeFeedback.mrv} sets\r\n            </span>\r\n            <div className=\"w-16 h-1 bg-zinc-800 rounded-full overflow-hidden ml-1\">\r\n              <div\r\n                className={cn(\r\n                  \"h-full transition-all duration-500\",\r\n                  volumeFeedback.status === \"OVER\"\r\n                    ? \"bg-red-500\"\r\n                    : volumeFeedback.status === \"OPTIMAL\"\r\n                      ? \"bg-green-500\"\r\n                      : \"bg-cyan-500\",\r\n                )}\r\n                style={{\r\n                  width: `${Math.min(100, volumeFeedback.percentage)}%`,\r\n                }}\r\n              />\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* Rest Timer Overlay - Only when active */}\r\n        <BiometricsHUD />\r\n\r\n        <div className=\"flex justify-between items-center mt-4\">\r\n          <div className=\"flex gap-2\">\r\n            <button\r\n              onClick={() => setIsVisionActive(!isVisionActive)}\r\n              className={cn(\r\n                \"p-2 rounded-lg border-2 transition-all flex items-center gap-2 font-bold text-xs uppercase tracking-widest\",\r\n                isVisionActive\r\n                  ? \"bg-cyan-500/20 border-cyan-500 text-cyan-400 shadow-[0_0_15px_rgba(6,182,212,0.3)]\"\r\n                  : \"bg-zinc-900 border-zinc-800 text-zinc-500 hover:border-zinc-500\",\r\n              )}\r\n            >\r\n              {isVisionActive ? (\r\n                <Eye className=\"w-4 h-4\" />\r\n              ) : (\r\n                <EyeOff className=\"w-4 h-4\" />\r\n              )}\r\n              Titan Vision\r\n            </button>\r\n          </div>\r\n\r\n          <ForgeButton\r\n            variant={isQuestFullyCompleted ? \"magma\" : \"default\"}\r\n            onClick={handleButtonClick}\r\n            disabled={!isQuestFullyCompleted && completedSets < totalSets}\r\n          >\r\n            {isQuestFullyCompleted ? \"Loot Boss\" : \"Flee Dungeon\"}\r\n          </ForgeButton>\r\n        </div>\r\n      </div>\r\n\r\n      {/* 2. MAIN BATTLEFIELD */}\r\n      <ScreenShake triggerKey={shakeTrigger} intensity={0.7}>\r\n        <main className=\"flex-grow space-y-6 pb-24 overflow-y-auto no-scrollbar bg-zinc-900/10 rounded-xl p-4 border border-zinc-800/50 relative\">\r\n          <AnimatePresence>\r\n            {isVisionActive && (\r\n              <div className=\"mb-4\">\r\n                <VisionRepCounter\r\n                  isActive={isVisionActive}\r\n                  onRepCount={handleVisionRep}\r\n                  onClose={() => setIsVisionActive(false)}\r\n                />\r\n              </div>\r\n            )}\r\n          </AnimatePresence>\r\n\r\n          <AnimatePresence>\r\n            {exercises.map((ex, index) => {\r\n              // Superset Logic:\r\n              // If this exercise has a supersetId....\r\n              if (ex.supersetId) {\r\n                const supersetGroup = exercises.filter(e => e.supersetId === ex.supersetId);\r\n                const firstInGroup = supersetGroup[0];\r\n\r\n                // Only render if this IS the first one in the group (to avoid duplicates)\r\n                if (ex.id === firstInGroup.id) {\r\n                  return (\r\n                    <div key={`superset-${ex.supersetId}`} ref={index === activeExIndex || exercises[activeExIndex]?.supersetId === ex.supersetId ? activeRef : null}>\r\n                      <SupersetGroup\r\n                        exercises={supersetGroup}\r\n                        activeIndex={activeExIndex}\r\n                        globalStartIndex={index} // Assumes they are contiguous. \r\n                        onSetLog={(idx, w, r, rpe) => handleSetLog(w, r, rpe, idx)}\r\n                        onNotesChange={(idx, notes) => handleNotesChange(notes, idx)}\r\n                        onSetUpdate={(exIdx, setIdx, updates) => handleSetUpdate(exIdx, setIdx, updates)}\r\n                      />\r\n                    </div>\r\n                  );\r\n                } else {\r\n                  // Skip rendering, it was handled by the first one\r\n                  return null;\r\n                }\r\n              }\r\n\r\n              return (\r\n                <div key={ex.id} ref={index === activeExIndex ? activeRef : null}>\r\n                  <ExerciseView\r\n                    exercise={ex}\r\n                    isActive={index === activeExIndex}\r\n                    isCompleted={\r\n                      index < activeExIndex || ex.sets.every((s) => s.completed)\r\n                    }\r\n                    onSetLog={handleSetLog}\r\n                    onNotesChange={(notes) => handleNotesChange(notes, index)}\r\n                    onSetUpdate={(setIndex, updates) => handleSetUpdate(index, setIndex, updates)}\r\n                  />\r\n                </div>\r\n              )\r\n            })}\r\n          </AnimatePresence>\r\n        </main>\r\n      </ScreenShake>\r\n\r\n      {/* 3. MODALS & OVERLAYS */}\r\n      <div className=\"fixed bottom-24 left-4 z-40 max-w-sm\">\r\n        <CardiacDriftWarning driftPercentage={metrics.drift} />\r\n      </div>\r\n      <BerserkerOverlay isActive={isBerserkerMode} />\r\n      <LiveSessionHUD onSessionJoin={(id) => setActiveSessionId(id)} />\r\n      <GhostOverlay events={ghostEvents} currentUserId={user?.id} />\r\n\r\n      <AnimatePresence>\r\n        {jokerPrompt.show && (\r\n          <OverchargePrompt\r\n            onAccept={handleJokerAccept}\r\n            onDecline={handleJokerDecline}\r\n            suggestedWeight={jokerPrompt.weight}\r\n          />\r\n        )}\r\n      </AnimatePresence>\r\n\r\n      {\r\n        showBerserkerChoice && (\r\n          <BerserkerChoice\r\n            onAccept={handleBerserkerAccept}\r\n            onDecline={handleBerserkerDecline}\r\n          />\r\n        )\r\n      }\r\n\r\n      {\r\n        isBerserkerMode && (\r\n          <BerserkerMode\r\n            lastExerciseName={exercises[activeExIndex].name}\r\n            onComplete={handleBerserkerComplete}\r\n          />\r\n        )\r\n      }\r\n\r\n      <PRCelebration\r\n        isVisible={showPRCelebration}\r\n        newReps={prData.newReps}\r\n        previousReps={prData.oldMax}\r\n        exerciseName={exercises[activeExIndex]?.name}\r\n        onClose={() => setShowPRCelebration(false)}\r\n      />\r\n    </div >\r\n  );\r\n};\r\n\r\nexport default DungeonSessionView;\r\n","usedDeprecatedRules":[]}]
