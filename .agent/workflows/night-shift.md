---
description: "Autonomous nightly maintenance workflow"
command: "/night-shift"
category: "meta"
trigger: "manual"
version: "2.0.0"
telemetry: "enabled"
primary_agent: "@manager"
domain: "meta"
flags:
  - "--no-telemetry"
  - "--dry-run"
  - "--skip-debt"
---

// turbo-all

# ðŸŒ™ The Night Shift v2.0

**Role:** The Autonomous Nightly Janitor.
**Goal:** Perform time-consuming maintenance while the team sleepsâ€”zero interruptions.

---

## ðŸ”§ Pre-Flight Checks

```bash
if [ -f ROADMAP.md ]; then
  if ! /triage; then
    echo "Triaging failed" >> night-shift.log
    exit 1
  fi
else
  echo "ROADMAP.md missing, skipping triage" >> night-shift.log
fi
```

---

## ðŸ“‹ Protocol

### Phase 1: Parallel Analysis (non-mutating)

Run these concurrently to maximize throughput:

```bash
timeout 45m /perf || { echo "Performance scan failed" >> night-shift.log; exit 1; }
# Spawn parallel jobs
/triage --analyze-only > triage_report.md 2>&1 &
PID_TRIAGE=$!

/perf --json > perf_report.json 2>&1 &
PID_PERF=$!

/evolve --dry-run > evolve_plan.md 2>&1 &
PID_EVOLVE=$!

# Wait for all with timeout (30 min max)
timeout 1800 bash -c "wait $PID_TRIAGE $PID_PERF $PID_EVOLVE" || {
  echo "â±ï¸ Analysis phase timed out" >> "$LOG"
  kill $PID_TRIAGE $PID_PERF $PID_EVOLVE 2>/dev/null
}
echo "âœ… Phase 1 complete" >> "$LOG"
```

### Phase 2: Sequential Mutations (with rollback)

```bash
# 2.1 Apply triage updates
if [ -s triage_report.md ]; then
  /triage --apply || { echo "âŒ Triage apply failed" >> "$LOG"; git stash pop; exit 1; }
  TRIAGE_RESULT="$(head -1 triage_report.md)"
else
  TRIAGE_RESULT="Skipped"
fi

# 2.2 Apply safe evolutions (no breaking changes)
if ! grep -q "BREAKING CHANGE" evolve_plan.md 2>/dev/null; then
  /evolve --auto-apply || echo "âš ï¸ Evolution apply failed (non-fatal)" >> "$LOG"
  EVOLVE_RESULT="Applied"
else
  EVOLVE_RESULT="Blocked (breaking changes detected)"
  echo "âš ï¸ Evolution blocked: breaking changes" >> "$LOG"
fi

# 2.3 Conservative debt attack with retry
DEBT_RESULT="None"
if [ "$SKIP_DEBT" != "true" ]; then
  for attempt in 1 2 3; do
    if /debt-attack 1 --strict 2>&1 | tee -a "$LOG"; then
      DEBT_RESULT="$(grep -oP 'Fixed: \K.*' "$LOG" | tail -1)"
      break
    else
      echo "âš ï¸ Debt attack attempt $attempt failed, retrying..." >> "$LOG"
      sleep 5
    fi
  done
fi
```

### Phase 3: Performance Metrics Extraction

```bash
/evolve --dry-run > evolve_plan.md
if grep -q "BREAKING CHANGE" evolve_plan.md; then
  echo "Evolution has breaking changes, aborting" >> night-shift.log
  exit 1
else
  /evolve --auto-apply
# Extract Lighthouse scores from JSON
if [ -f perf_report.json ]; then
  PERF_SCORE=$(jq -r '.categories.performance.score // "N/A"' perf_report.json)
  BUNDLE_SIZE=$(jq -r '.bundleSize // "N/A"' perf_report.json)
  PERF_RESULT="Score: ${PERF_SCORE}, Bundle: ${BUNDLE_SIZE}"
else
  PERF_RESULT="Report not generated"
fi
```

---

## ðŸ“ Phase 4: Morning Briefing Generation

```bash
DATE=$(date +%Y-%m-%d)

cat > DAILY_BRIEF.md << EOF
# â˜€ï¸ Morning Briefing for $DATE

> Generated by Night Shift v2.0 at $(date +%H:%M)

## ðŸŒ™ Nightly Actions

| Task | Result |
|------|--------|
| ðŸ—ºï¸ Roadmap Triage | $TRIAGE_RESULT |
| ðŸš€ Performance | $PERF_RESULT |
| ðŸ§¬ Evolution | $EVOLVE_RESULT |
| ðŸ§¹ Debt Fixed | $DEBT_RESULT |

## ðŸ“Š Detailed Reports

- [Triage Report](triage_report.md)
- [Performance Report](perf_report.json)
- [Evolution Plan](evolve_plan.md)
- [Full Log]($LOG)

## ðŸŽ¯ Suggested Focus Today

$(head -3 ROADMAP.md | grep -E '^\s*-' || echo "- Review ROADMAP.md for priorities")

---

*Night Shift completed at $(date)*
EOF

echo "âœ… DAILY_BRIEF.md generated" >> "$LOG"
```

---

## ðŸ§¹ Cleanup

```bash
# Remove checkpoint if successful
git stash drop 2>/dev/null || true

# Archive old logs (keep last 7)
mkdir -p .agent/logs
mv night-shift-*.log .agent/logs/ 2>/dev/null
ls -t .agent/logs/night-shift-*.log | tail -n +8 | xargs rm -f 2>/dev/null

echo "ðŸŒ™ Night Shift completed successfully at $(date)" >> ".agent/logs/$LOG"
```

---

## Version History

### 2.0.0 (2026-01-15)

- **Parallel execution** for analysis phase (3x faster)
- **turbo-all** annotation for zero permission prompts
- **Dynamic briefing** with actual values (no placeholders)
- **Auto-retry** for debt attacks (3 attempts)
- **Git checkpoint** for safe rollback
- **Structured logging** with timestamps
- **Flag support**: `--no-telemetry`, `--dry-run`, `--skip-debt`

### 1.0.0 (2026-01-08)

- Initial stable release with standardized metadata

## References

- [Nightâ€‘Shift Permissions](night-shift-permissions.md)
- [Nightâ€‘Shift Log](night-shift.log)
