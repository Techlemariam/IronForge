<!-- markdownlint-disable MD041 -->
---
description: "Autonomous nightly maintenance workflow"
command: "/night-shift"
category: "meta"
trigger: "manual"
version: "2.3.0"
telemetry: "enabled"
primary_agent: "@manager"
domain: "meta"
flags:

- "--no-telemetry"
- "--dry-run"
- "--skip-debt"

---

// turbo-all

# ðŸŒ™ The Night Shift v2.3

**Role:** The Autonomous Nightly Janitor.
**Goal:** Perform time-consuming maintenance while the team sleepsâ€”zero interruptions, fully isolated on a fresh branch.

---

## ðŸ”§ Pre-Flight & Branching

```bash
# Initialize log with timestamp
LOG="night-shift-$(date +%Y%m%d-%H%M%S).log"
echo "ðŸŒ™ Night Shift started at $(date)" > "$LOG"

# 1. Capture Context
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "ðŸ“ Starting from branch: $CURRENT_BRANCH" >> "$LOG"

# 2. Check git status - abort if dirty
if [ -n "$(git status --porcelain)" ]; then
  echo "âŒ Working directory not clean, aborting" >> "$LOG"
  exit 1
fi

# 3. Create & Switch to Night Shift Branch
# References /switch-branch for safe isolation
TARGET_BRANCH="night-shift/$(date +%Y-%m-%d)"
echo "ðŸ”€ Switching to maintenance branch: $TARGET_BRANCH" >> "$LOG"

if git show-ref --verify --quiet refs/heads/"$TARGET_BRANCH"; then
  git checkout "$TARGET_BRANCH"
else
  git checkout -b "$TARGET_BRANCH"
fi

# 4. Validate Environment
for file in ROADMAP.md DEBT.md; do
  [ -f "$file" ] || { echo "âš ï¸ $file missing" >> "$LOG"; }
done
```

---

## ðŸ“‹ Protocol

### Phase 1: Parallel Analysis (Optimized Atomic Command Strategy)

**Strategy:** Avoid pipes (`|`) and redirections (`>`) in complex commands. Use PowerShell-native file operations and separate atomic commands to prevent permission interruptions.

```powershell
# Security Audit (High severity only) - Atomic command
pnpm audit --audit-level=high --json | Out-File -FilePath security_report.json -Encoding utf8

# Dependency Evolution Check - Atomic command
npm outdated --json | Out-File -FilePath evolve_report.json -Encoding utf8

# Technical Debt Triage - Use grep_search tool instead of shell grep
# Agent will use grep_search with pattern "TODO|FIXME|ANY" on src/ and tests/
# Results stored in triage_report.md via agent tooling

# Performance Scan - Placeholder for future Lighthouse integration
# Currently generates minimal report
echo '{"status":"pending","note":"Lighthouse requires dev server"}' | Out-File -FilePath perf_report.json -Encoding utf8

# Note: All commands run sequentially to avoid permission prompts
# Parallel execution sacrificed for reliability in autonomous mode
```

### Phase 2: Sequential Mutations (with rollback)

```bash
# 2.1 Apply triage updates
if [ -s triage_report.md ]; then
  /triage --apply || { echo "âŒ Triage apply failed" >> "$LOG"; git checkout .; exit 1; }
  TRIAGE_RESULT="$(head -1 triage_report.md)"
else
  TRIAGE_RESULT="Skipped"
fi

# 2.2 Apply safe evolutions (no breaking changes)
if ! grep -q "BREAKING CHANGE" evolve_plan.md 2>/dev/null; then
  /evolve --auto-apply || echo "âš ï¸ Evolution apply failed (non-fatal)" >> "$LOG"
  EVOLVE_RESULT="Applied"
else
  EVOLVE_RESULT="Blocked (breaking changes detected)"
  echo "âš ï¸ Evolution blocked: breaking changes" >> "$LOG"
fi

# 2.3 Conservative debt attack with retry
DEBT_RESULT="None"
if [ "$SKIP_DEBT" != "true" ]; then
  for attempt in 1 2 3; do
    if /debt-attack 1 --strict 2>&1 | tee -a "$LOG"; then
      DEBT_RESULT="$(grep -oP 'Fixed: \K.*' "$LOG" | tail -1)"
      break
    else
      echo "âš ï¸ Debt attack attempt $attempt failed, retrying..." >> "$LOG"
      sleep 5
    fi
  done
fi
```

### Phase 3: Extraction & Hygiene

```powershell
# Extract Security Stats - PowerShell native JSON parsing
if (Test-Path security_report.json) {
  $secReport = Get-Content security_report.json | ConvertFrom-Json
  $vulnCount = $secReport.metadata.vulnerabilities.high + $secReport.metadata.vulnerabilities.critical
  $SEC_RESULT = "$vulnCount Critical/High Issues"
} else {
  $SEC_RESULT = "Audit Failed"
}

# Extract Performance Stats
if (Test-Path perf_report.json) {
  $perfReport = Get-Content perf_report.json | ConvertFrom-Json
  $PERF_RESULT = $perfReport.status ?? "N/A"
} else {
  $PERF_RESULT = "Report not generated"
}

# Extract Evolution Stats
if (Test-Path evolve_report.json) {
  $evolveReport = Get-Content evolve_report.json | ConvertFrom-Json
  $updateCount = ($evolveReport.PSObject.Properties | Measure-Object).Count
  $EVOLVE_RESULT = "Updated: $updateCount packages"
} else {
  $EVOLVE_RESULT = "No updates"
}
```

---

## ðŸ“ Phase 4: Briefing & PR Submission

### 4.1 Generate Briefing

```bash
DATE=$(date +%Y-%m-%d)
BRIEF_FILE="DAILY_BRIEF.md"

cat > "$BRIEF_FILE" << EOF
# â˜€ï¸ Morning Briefing for $DATE

> Generated by Night Shift v2.3 at $(date +%H:%M) // branch: $TARGET_BRANCH

## ðŸŒ™ Nightly Actions

| Task | Result |
|------|--------|
| ðŸ—ºï¸ Roadmap Triage | $TRIAGE_RESULT |
| ðŸ›¡ï¸ Security Audit | $SEC_RESULT |
| ðŸš€ Performance | $PERF_RESULT |
| ðŸ§¬ Evolution | $EVOLVE_RESULT |
| ðŸ§¹ Debt Fixed | $DEBT_RESULT |

## ðŸ“Š Detailed Reports

- [Triage Report](triage_report.md)
- [Security Report](security_report.json)
- [Performance Report](perf_report.json)
- [Evolution Plan](evolve_plan.md)
- [Full Log]($LOG)

## ðŸŽ¯ Suggested Focus Today

$(head -3 ROADMAP.md 2>/dev/null | grep -E '^\s*-' || echo "- Review ROADMAP.md for priorities")

---

*Night Shift completed at $(date)*
EOF

echo "âœ… $BRIEF_FILE generated" >> "$LOG"
```

### 4.2 Automated PR Creation (References /pre-pr)

```bash
git add .
if ! git diff --cached --quiet; then
  
  COMMIT_MSG="chore(night-shift): maintenance for $DATE"
  git commit -m "$COMMIT_MSG"
  
  echo "ðŸš€ Changes detected. Initiating PR sequence..." >> "$LOG"
  
  git push -u origin "$TARGET_BRANCH"
  
  PR_URL=$(gh pr create \
    --title "$COMMIT_MSG" \
    --body-file "$BRIEF_FILE" \
    --label "night-shift" \
    --label "automated" \
    --reviewer "@manager" 2>/dev/null)
    
  echo "ðŸ”— PR Created: $PR_URL" >> "$LOG"

else
  echo "ðŸ’¤ No changes to commit. Skipping PR." >> "$LOG"
fi
```

---

## ðŸ§¹ Cleanup & Restore

```bash
# Return to original branch
echo "ðŸ”™ Returning to $CURRENT_BRANCH" >> "$LOG"
git checkout "$CURRENT_BRANCH"

# Git Hygiene: Prune merged branches (except main, current, and night-shift)
echo "ðŸ§¹ Running Git Hygiene..." >> "$LOG"
git fetch -p
# Note: xargs -r is GNU specific, using standard if check
MERGED_BRANCHES=$(git branch --merged main | grep -vE "^\*|main|night-shift")
if [ -n "$MERGED_BRANCHES" ]; then
  echo "$MERGED_BRANCHES" | xargs git branch -d
  echo "Deleted merged branches:" >> "$LOG"
  echo "$MERGED_BRANCHES" >> "$LOG"
else
  echo "No merged branches to clean." >> "$LOG"
fi

# Archive logs
mkdir -p .agent/logs
mv night-shift-*.log .agent/logs/ 2>/dev/null

echo "ðŸŒ™ Night Shift v2.3 cycle complete."
```

---

## Version History

### 2.3.0 (2026-01-15)

- **Optimized Atomic Command Strategy**: Eliminates permission interruptions by:
  - Replacing bash-style pipes and redirections with PowerShell-native `Out-File`
  - Using `grep_search` agent tool instead of shell `grep`
  - Converting `jq` JSON parsing to PowerShell `ConvertFrom-Json`
  - Running commands sequentially instead of parallel to ensure reliability
- **PowerShell Native**: All commands now use PowerShell cmdlets for cross-platform compatibility

### 2.2.0 (2026-01-15)

- **Security Audit**: Adds `npm audit` to parallel checks.
- **Git Hygiene**: Prunes merged local branches in cleanup phase.
- **Reporting**: Adds security stats to `DAILY_BRIEF.md`.

### 2.1.0 (2026-01-15)

- Integrated Branching & Pre-PR logic.

### 2.0.0 (2026-01-15)

- Parallel execution, turbo-all, git checkpoint.

---

## References

- [Switch Branch Logic](switch-branch.md)
- [Pre-PR Logic](pre-pr.md)
- [Nightâ€‘Shift Permissions](night-shift-permissions.md)
- [Logs Directory](.agent/logs/)
