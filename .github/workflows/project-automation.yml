name: Project Automation

on:
  issues:
    types: [closed, reopened]
  pull_request:
    types: [opened, closed]

# GitHub Project V2 Configuration
# IDs are stored in .agent/config/github-project.json
# These env vars provide a fallback for GitHub Actions context
env:
  PROJECT_ID: PVT_kwHOAe3KCM4BMt-p
  STATUS_FIELD_ID: PVTSSF_lAHOAe3KCM4BMt-pzg76_fI
  STATUS_BACKLOG: f75ad846
  STATUS_IN_PROGRESS: 47fc9ee4
  STATUS_IN_REVIEW: 881f842c
  STATUS_MERGED_STAGING: 3ac5a295
  STATUS_DONE: 98236657

jobs:
  update_project:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      repository-projects: write
    
    env:
      GITHUB_TOKEN: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      # ===== ISSUE EVENTS =====
      
      - name: Move Closed Issue to Done
        if: github.event_name == 'issues' && github.event.action == 'closed'
        shell: pwsh
        run: |
          .agent/scripts/link-issue-to-project.ps1 `
            -IssueNumber ${{ github.event.issue.number }} `
            -Status "done" `
            -Verbose

      - name: Move Reopened Issue to In Progress
        if: github.event_name == 'issues' && github.event.action == 'reopened'
        shell: pwsh
        run: |
          .agent/scripts/link-issue-to-project.ps1 `
            -IssueNumber ${{ github.event.issue.number }} `
            -Status "in_progress" `
            -Verbose

      # ===== PULL REQUEST EVENTS =====
      
      - name: Link PR to Project on Open
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        shell: pwsh
        run: |
          .agent/scripts/link-pr-to-project.ps1 `
            -PRNumber ${{ github.event.pull_request.number }} `
            -Status "in_review" `
            -Verbose

      - name: Move Merged PR to Done
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
        shell: pwsh
        run: |
          .agent/scripts/link-pr-to-project.ps1 `
            -PRNumber ${{ github.event.pull_request.number }} `
            -Status "done" `
            -Verbose
          
          # Also update linked issues if found in body (handled by script?)
          # The script currently doesn't auto-parse linked issues from PR body for status updates.
          # TODO: Add that capability to the script for 100% parity, 
          # but for now the PR status update is the critical part.

      - name: Move Closed PR (not merged) to Backlog
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == false
        shell: pwsh
        run: |
          .agent/scripts/link-pr-to-project.ps1 `
            -PRNumber ${{ github.event.pull_request.number }} `
            -Status "backlog" `
            -Verbose
