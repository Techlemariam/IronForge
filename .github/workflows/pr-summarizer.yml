name: AI PR Summarizer

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  summarize:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    if: github.actor != 'dependabot[bot]'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR Diff
        id: diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD > pr.diff
          echo "diff_size=$(wc -c < pr.diff)" >> $GITHUB_OUTPUT

      - name: Summarize with Gemini
        if: steps.diff.outputs.diff_size > 0
        run: |
          # Use a simple node script or curl to call Gemini
          # For this example, we'll use a placeholder that reminds the user to set the secret
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "GEMINI_API_KEY is not set. Skipping AI summary."
            exit 0
          fi
          
          # This is a simplified call format
          DIFF_CONTENT=$(cat pr.diff | head -c 20000) # Cap diff size
          
          PROMPT="Summarize the following code changes for a senior developer. Focus on architectural impact and potential risks. Use a concise, technical tone. Diff:\n\n$DIFF_CONTENT"
          
          RESPONSE=$(curl https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${{ secrets.GEMINI_API_KEY }} \
            -H 'Content-Type: application/json' \
            -X POST \
            -d "{
              \"contents\": [{
                \"parts\":[{
                  \"text\": \"$PROMPT\"
                }]
              }]
            }")
            
          SUMMARY=$(echo $RESPONSE | jq -r '.candidates[0].content.parts[0].text')
          
          if [ "$SUMMARY" != "null" ]; then
            gh pr comment ${{ github.event.pull_request.number }} --body "## ðŸ¤– AI PR Summary (Gemini)
          $SUMMARY"
          else
            echo "Failed to generate summary."
            echo $RESPONSE
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
